import { normalizeUrl } from "./http-client";

export interface ReferenceWithProvenance {
  url: string;
  normalizedUrl: string;
  sources: string[];
  tags: string[];
}

export function deduplicateReferences(
  references: Array<{ url: string; source: string; tags?: string[] }>
): ReferenceWithProvenance[] {
  const byNormalizedUrl = new Map<string, ReferenceWithProvenance>();

  for (const ref of references) {
    const normalized = normalizeUrl(ref.url);
    const existing = byNormalizedUrl.get(normalized);

    if (existing) {
      // Merge sources and tags
      if (!existing.sources.includes(ref.source)) {
        existing.sources.push(ref.source);
      }
      if (ref.tags) {
        for (const tag of ref.tags) {
          if (!existing.tags.includes(tag)) {
            existing.tags.push(tag);
          }
        }
      }
    } else {
      byNormalizedUrl.set(normalized, {
        url: ref.url,
        normalizedUrl: normalized,
        sources: [ref.source],
        tags: ref.tags || [],
      });
    }
  }

  return Array.from(byNormalizedUrl.values());
}
