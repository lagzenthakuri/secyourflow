import type { IngestionConfig } from "../config";
import { HttpClient } from "../utils/http-client";
import { logger } from "../utils/logger";

interface KevCatalog {
  title: string;
  catalogVersion: string;
  dateReleased: string;
  count: number;
  vulnerabilities: Array<{
    cveID: string;
    vendorProject: string;
    product: string;
    vulnerabilityName: string;
    dateAdded: string;
    shortDescription: string;
    requiredAction: string;
    dueDate: string;
    knownRansomwareCampaignUse: string;
    notes: string;
  }>;
}

export interface KevEnrichment {
  cveId: string;
  flag: boolean;
  dateAdded: Date | null;
  dueDate: Date | null;
  requiredAction: string | null;
  vulnerabilityName: string | null;
  notes: string | null;
  ransomwareUse: boolean | null;
}

export class KevIngestionAdapter {
  private readonly config: IngestionConfig;
  private readonly httpClient: HttpClient;

  constructor(config: IngestionConfig, httpClient: HttpClient) {
    this.config = config;
    this.httpClient = httpClient;
  }

  async fetchCatalog(): Promise<Map<string, KevEnrichment>> {
    logger.info("Fetching CISA KEV catalog");

    const response = await this.httpClient.fetch<KevCatalog>(this.config.cisa.kevUrl);
    const catalog = response.data;

    const enrichments = new Map<string, KevEnrichment>();

    for (const vuln of catalog.vulnerabilities) {
      const cveId = vuln.cveID.toUpperCase();
      
      enrichments.set(cveId, {
        cveId,
        flag: true,
        dateAdded: this.parseDate(vuln.dateAdded),
        dueDate: this.parseDate(vuln.dueDate),
        requiredAction: vuln.requiredAction || null,
        vulnerabilityName: vuln.vulnerabilityName || null,
        notes: vuln.notes || null,
        ransomwareUse: vuln.knownRansomwareCampaignUse?.toLowerCase() === "known",
      });
    }

    logger.info("KEV catalog fetched", { count: enrichments.size });

    return enrichments;
  }

  private parseDate(dateStr: string): Date | null {
    try {
      return new Date(dateStr);
    } catch {
      return null;
    }
  }
}
