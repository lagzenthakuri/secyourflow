export interface IngestionConfig {
  nvd: {
    apiKey: string | null;
    baseUrl: string;
    cpeBaseUrl: string;
    rateLimit: {
      requestsPer30Seconds: number;
      concurrency: number;
    };
    pagination: {
      resultsPerPage: number;
      maxWindowDays: number;
    };
    minIntervalHours: number;
  };
  github: {
    token: string | null;
    cveListRepo: string;
  };
  cisa: {
    kevUrl: string;
  };
  epss: {
    baseUrl: string;
    rateLimit: {
      requestsPerMinute: number;
      maxCvesPerRequest: number;
    };
  };
  storage: {
    keepRawPayloads: boolean;
    rawPayloadSizeLimit: number;
  };
}

export function getIngestionConfig(): IngestionConfig {
  const nvdApiKey = process.env.NVD_API_KEY || null;
  
  return {
    nvd: {
      apiKey: nvdApiKey,
      baseUrl: process.env.NVD_API_BASE_URL || "https://services.nvd.nist.gov/rest/json/cves/2.0",
      cpeBaseUrl: process.env.NVD_CPE_BASE_URL || "https://services.nvd.nist.gov/rest/json/cpematch/2.0",
      rateLimit: {
        requestsPer30Seconds: nvdApiKey ? 50 : 5,
        concurrency: parseInt(process.env.INGEST_CONCURRENCY || "1", 10),
      },
      pagination: {
        resultsPerPage: 2000,
        maxWindowDays: parseInt(process.env.INGEST_MAX_WINDOW_DAYS || "120", 10),
      },
      minIntervalHours: parseInt(process.env.INGEST_MIN_INTERVAL_HOURS || "2", 10),
    },
    github: {
      token: process.env.GITHUB_TOKEN || null,
      cveListRepo: "CVEProject/cvelistV5",
    },
    cisa: {
      kevUrl: process.env.CISA_KEV_URL || "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json",
    },
    epss: {
      baseUrl: process.env.EPSS_API_BASE_URL || "https://api.first.org/data/v1/epss",
      rateLimit: {
        requestsPerMinute: 1000,
        maxCvesPerRequest: 100, // Conservative to stay under ~2000 char limit
      },
    },
    storage: {
      keepRawPayloads: true,
      rawPayloadSizeLimit: 1024 * 1024, // 1MB per payload
    },
  };
}
