export type CveState = "PUBLISHED" | "REJECTED" | "RESERVED" | "UNKNOWN";

export interface IngestionCheckpoint {
  source: string;
  cursor: string | null;
  windowStart: string | null;
  windowEnd: string | null;
  lastSuccessAt: Date | null;
  recordsProcessed: number;
  status: "idle" | "running" | "error";
  errorMessage: string | null;
}

export interface SourceProvenance {
  sourceName: string;
  fetchedAt: Date;
  sourceVersion: string | null;
  url: string;
  rawJsonHash: string;
  rawJson: string | null; // Stored if under size limit
}

export interface NormalizedCveDocument {
  cveId: string;
  state: CveState;
  published: Date | null;
  lastModified: Date;
  
  // Content
  descriptions: Array<{ lang: string; value: string }>;
  references: Array<{
    url: string;
    normalizedUrl: string;
    sources: string[]; // Which containers/sources added this ref
    tags: string[];
  }>;
  
  // Affected
  affected: {
    cpe: Array<{
      uri: string;
      vendor: string;
      product: string;
      version: string;
      versionStartIncluding: string | null;
      versionEndExcluding: string | null;
      vulnerable: boolean;
    }>;
    packages: Array<{
      ecosystem: string;
      name: string;
      ranges: string[];
    }>;
  };
  
  // Metrics
  metrics: {
    best: {
      version: string;
      baseScore: number;
      severity: string;
      vector: string;
    } | null;
    allRaw: Array<{
      version: string;
      baseScore: number;
      severity: string;
      vector: string;
      source: string;
    }>;
  };
  
  // Weakness
  weakness: Array<{
    cweId: string;
    description: string | null;
  }>;
  
  // KEV
  kev: {
    flag: boolean;
    dateAdded: Date | null;
    dueDate: Date | null;
    requiredAction: string | null;
    vulnerabilityName: string | null;
    notes: string | null;
    ransomwareUse: boolean | null;
  };
  
  // EPSS
  epss: {
    score: number | null;
    percentile: number | null;
    date: Date | null;
  };
  
  // Provenance
  sources: SourceProvenance[];
}

export interface IngestionResult {
  source: string;
  success: boolean;
  recordsFetched: number;
  recordsCreated: number;
  recordsUpdated: number;
  recordsSkipped: number;
  errors: string[];
  warnings: string[];
  durationMs: number;
  checkpoint: IngestionCheckpoint;
}

export interface IngestionHealthStatus {
  sources: Array<{
    name: string;
    lastSuccessAt: Date | null;
    lastAttemptAt: Date | null;
    status: "healthy" | "degraded" | "down";
    errorMessage: string | null;
    recordsProcessed: number;
  }>;
  overallStatus: "healthy" | "degraded" | "down";
}
