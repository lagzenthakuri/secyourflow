import { describe, it, expect } from "vitest";
import { deduplicateReferences } from "../utils/url-deduper";

describe("deduplicateReferences", () => {
  it("should deduplicate identical URLs", () => {
    const refs = [
      { url: "https://example.com/vuln", source: "NVD", tags: ["Patch"] },
      { url: "https://example.com/vuln", source: "MITRE", tags: ["Advisory"] },
    ];

    const result = deduplicateReferences(refs);

    expect(result).toHaveLength(1);
    expect(result[0].sources).toEqual(["NVD", "MITRE"]);
    expect(result[0].tags).toEqual(["Patch", "Advisory"]);
  });

  it("should normalize URLs before deduplication", () => {
    const refs = [
      { url: "https://example.com/vuln?utm_source=test", source: "NVD" },
      { url: "https://example.com/vuln", source: "MITRE" },
      { url: "HTTPS://EXAMPLE.COM/vuln", source: "CVE-List" },
    ];

    const result = deduplicateReferences(refs);

    expect(result).toHaveLength(1);
    expect(result[0].sources).toEqual(["NVD", "MITRE", "CVE-List"]);
  });

  it("should preserve provenance for each source", () => {
    const refs = [
      { url: "https://example.com/a", source: "NVD", tags: ["Patch"] },
      { url: "https://example.com/b", source: "NVD", tags: ["Advisory"] },
      { url: "https://example.com/a", source: "MITRE", tags: ["Vendor"] },
    ];

    const result = deduplicateReferences(refs);

    expect(result).toHaveLength(2);
    
    const refA = result.find((r) => r.normalizedUrl.includes("/a"));
    expect(refA?.sources).toEqual(["NVD", "MITRE"]);
    expect(refA?.tags).toEqual(["Patch", "Vendor"]);

    const refB = result.find((r) => r.normalizedUrl.includes("/b"));
    expect(refB?.sources).toEqual(["NVD"]);
    expect(refB?.tags).toEqual(["Advisory"]);
  });

  it("should handle empty input", () => {
    const result = deduplicateReferences([]);
    expect(result).toHaveLength(0);
  });

  it("should remove tracking parameters", () => {
    const refs = [
      { url: "https://example.com/vuln?utm_campaign=test&fbclid=123", source: "NVD" },
    ];

    const result = deduplicateReferences(refs);

    expect(result[0].normalizedUrl).not.toContain("utm_");
    expect(result[0].normalizedUrl).not.toContain("fbclid");
  });
});
