# CVE Ingestion Module

Production-grade CVE data ingestion system with multi-source federation, rate limiting, incremental updates, and provenance tracking.

## Features

- **Multi-source ingestion**: NVD CVE API, CISA KEV, EPSS, CVE List (cvelistV5)
- **Rate limit compliance**: Token bucket rate limiter with adaptive backoff
- **Incremental updates**: Watermark-based sync with 120-day window enforcement
- **Provenance tracking**: Source attribution, checksums, and raw payload storage
- **Reference deduplication**: URL normalization with multi-source provenance
- **KEV resilience**: Primary from NVD fields, fallback to CISA catalog
- **EPSS batching**: Chunked requests under URL length limits
- **Resumable ingestion**: Checkpoint-based recovery from failures
- **Observable**: Structured JSON logs with metrics
- **Schema-drift tolerant**: Unknown fields logged but don't fail ingestion

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Ingestion Orchestrator                    │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │   NVD    │  │   KEV    │  │   EPSS   │  │ CVE List │   │
│  │ Adapter  │  │ Adapter  │  │ Adapter  │  │ Adapter  │   │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘   │
│       │             │             │             │           │
│       └─────────────┴─────────────┴─────────────┘           │
│                         │                                    │
│                    ┌────▼────┐                              │
│                    │  HTTP   │                              │
│                    │ Client  │                              │
│                    └────┬────┘                              │
│                         │                                    │
│                    ┌────▼────┐                              │
│                    │  Rate   │                              │
│                    │ Limiter │                              │
│                    └────┬────┘                              │
└─────────────────────────┼──────────────────────────────────┘
                          │
                    ┌─────▼─────┐
                    │    CVE    │
                    │Repository │
                    └─────┬─────┘
                          │
                    ┌─────▼─────┐
                    │  Prisma   │
                    │ Database  │
                    └───────────┘
```

## Data Flow

1. **NVD Ingestion** (Primary)
   - Fetch CVEs with `lastModStartDate`/`lastModEndDate`
   - Paginate with `startIndex`/`resultsPerPage`
   - Extract CVSS, CPE, references, KEV fields
   - Store with provenance

2. **KEV Enrichment**
   - Fetch CISA KEV catalog
   - Match by CVE ID
   - Update `isKev` flag and KEV details
   - Fallback to NVD embedded KEV fields

3. **EPSS Enrichment**
   - Batch CVE IDs (100 per request)
   - Fetch scores and percentiles
   - Update existing CVE records

4. **Reference Deduplication**
   - Normalize URLs (lowercase, remove tracking params)
   - Merge sources and tags
   - Preserve provenance

## Database Schema

### Core Tables

- **Cve**: Main CVE records with severity, status, KEV flag, EPSS scores
- **CveCvss**: All CVSS metrics (v2, v3.0, v3.1, v4.0) with source
- **CveCpe**: Affected products in CPE format
- **CveReference**: Deduplicated references with source provenance
- **CveProvenance**: Source tracking with checksums and timestamps
- **KevEntry**: KEV-specific data (dateAdded, dueDate, requiredAction)
- **IngestionState**: Checkpoints and status per source

## API Endpoints

### POST /api/admin/ingest

Trigger ingestion manually.

**Auth**: Requires `Authorization: Bearer $ADMIN_API_TOKEN`

**Body** (optional):
```json
{
  "source": "nvd" | "kev" | "epss"
}
```

**Response**:
```json
{
  "source": "NVD",
  "success": true,
  "recordsFetched": 1523,
  "recordsCreated": 45,
  "recordsUpdated": 1478,
  "recordsSkipped": 0,
  "errors": [],
  "warnings": [],
  "durationMs": 125340,
  "checkpoint": {
    "source": "NVD",
    "lastSuccessAt": "2026-02-07T10:30:00.000Z",
    "recordsProcessed": 150000,
    "status": "idle"
  }
}
```

### GET /api/health

Check ingestion health.

**Response**:
```json
{
  "status": "healthy",
  "attribution": "This product uses the NVD API but is not endorsed or certified by the NVD.",
  "sources": [
    {
      "name": "NVD",
      "lastSuccessAt": "2026-02-07T10:30:00.000Z",
      "status": "healthy",
      "recordsProcessed": 150000
    }
  ],
  "timestamp": "2026-02-07T11:00:00.000Z"
}
```

## Configuration

See `.env.example` for all options.

### Critical Settings

- `NVD_API_KEY`: Highly recommended (50 req/30s vs 5 req/30s)
- `INGEST_CONCURRENCY`: Keep at 1 for NVD rate limits
- `INGEST_MAX_WINDOW_DAYS`: 120 (NVD enforced)
- `INGEST_MIN_INTERVAL_HOURS`: 2 (NVD recommendation)

## Usage

### Initial Import

```bash
# Run full ingestion (may take 30-60 minutes)
curl -X POST http://localhost:3000/api/admin/ingest \
  -H "Authorization: Bearer $ADMIN_API_TOKEN"
```

### Incremental Updates

```bash
# Run every 6 hours via cron
0 */6 * * * curl -X POST http://localhost:3000/api/admin/ingest \
  -H "Authorization: Bearer $ADMIN_API_TOKEN"
```

### Monitoring

```bash
# Check health
curl http://localhost:3000/api/health

# View logs
docker logs <container> | grep '"level":"error"'

# Query checkpoints
psql $DATABASE_URL -c 'SELECT * FROM "IngestionState"'
```

## Testing

```bash
# Unit tests
npm test

# Smoke test (requires running server)
npm run test:smoke:cves:curl

# With real APIs (may hit rate limits)
REAL_API_TESTS=true npm test
```

## Rate Limits

| Source | Limit | Implementation |
|--------|-------|----------------|
| NVD (no key) | 5 req/30s | Token bucket |
| NVD (with key) | 50 req/30s | Token bucket |
| EPSS | 1000 req/min | Batch chunking |
| KEV | None | Reasonable retry |

## Incremental Update Rules

1. **Minimum interval**: 2 hours between automated syncs
2. **Maximum window**: 120 days per request
3. **Pagination**: Iterate `startIndex` until `totalResults` reached
4. **Watermark**: Track `lastModifiedAt` per source

## Provenance

Each CVE record tracks:
- **Source name**: NVD, KEV, EPSS, CVE-List
- **Fetch timestamp**: When data was retrieved
- **Source version**: API version or data version
- **URL**: Canonical source URL
- **Checksum**: SHA-256 of raw JSON
- **Raw payload**: Stored if under 1MB limit

## Error Handling

- **429/503**: Exponential backoff with jitter (1s, 2s, 4s, ...)
- **Timeout**: 30s per request
- **Max retries**: 3 attempts
- **Partial failures**: Log and continue, don't fail entire batch
- **Schema drift**: Log unknown fields, don't hard-fail

## Observability

### Structured Logs

All logs are JSON with:
- `timestamp`: ISO 8601
- `level`: debug | info | warn | error
- `message`: Human-readable
- Context fields (e.g., `cveId`, `source`, `durationMs`)

### Metrics

Track:
- Ingestion duration
- Records created/updated/skipped
- Error counts
- Rate limit waits
- Checkpoint timestamps

## Compliance

### NVD Terms of Use

- **Attribution required**: "This product uses the NVD API but is not endorsed or certified by the NVD."
- **Rate limits**: Must be respected
- **No redistribution**: Raw NVD data without permission

### CISA KEV

- Public domain, no restrictions

### EPSS

- Free to use, attribution appreciated

## Troubleshooting

See [RUNBOOK.md](../../../RUNBOOK.md) for detailed troubleshooting.

Common issues:
- Rate limit exceeded → Verify `NVD_API_KEY` is set
- Ingestion stuck → Reset `IngestionState.status` to 'idle'
- Missing KEV → Run KEV enrichment manually
- Stale EPSS → Run EPSS enrichment manually

## Future Enhancements

- [ ] Full CVE List (cvelistV5) ingestion via GitHub releases
- [ ] NVD CPEMatch API for product mapping
- [ ] Webhook notifications on KEV additions
- [ ] Prometheus metrics export
- [ ] Grafana dashboard templates
- [ ] Delta compression for raw payloads
- [ ] Multi-region replication
