import type { Severity } from "@prisma/client";
import type { ThreatIntelConfig } from "../config";
import type { AdapterContext, AdapterFetchResult, ThreatFeedAdapter, ThreatFeedAdapterHealth } from "./types";
import { fetchJsonWithRetry } from "../utils/http";
import { calculateConfidence, calculateExpirationDate } from "../ioc/scoring";
import { normalizeIndicatorValue } from "../ioc/normalizer";
import type { NormalizedIndicatorInput } from "../types";

interface MalwareBazaarResponse {
  query_status?: string;
  data?: Array<{
    sha256_hash?: string;
    first_seen?: string;
    file_type?: string;
    signature?: string;
    tags?: string[];
  }>;
}

interface MalwareBazaarRecord {
  hash: string;
  firstSeen: Date;
  fileType: string | null;
  signature: string | null;
  tags: string[];
}

export class MalwareBazaarAdapter implements ThreatFeedAdapter<MalwareBazaarRecord> {
  readonly source = "MALWAREBAZAAR";
  readonly feedType = "MALWARE" as const;

  constructor(private readonly config: ThreatIntelConfig) {}

  async fetchSince(checkpoint: string | null): Promise<AdapterFetchResult<MalwareBazaarRecord>> {
    void checkpoint;
    if (!this.config.feeds.malwareBazaarAuthKey) {
      return {
        records: [],
        checkpoint: null,
        warnings: ["MALWAREBAZAAR_AUTH_KEY not configured"],
      };
    }

    const payload = await fetchJsonWithRetry<MalwareBazaarResponse>({
      url: "https://mb-api.abuse.ch/api/v1/",
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "Auth-Key": this.config.feeds.malwareBazaarAuthKey,
      },
      body: "query=get_recent&selector=time",
      timeoutMs: this.config.ingestion.timeoutMs,
      maxRetries: this.config.ingestion.maxRetries,
      baseBackoffMs: this.config.ingestion.baseBackoffMs,
    });

    const records: MalwareBazaarRecord[] = [];
    for (const item of payload.data ?? []) {
      if (!item.sha256_hash) continue;
      const firstSeen = item.first_seen ? new Date(item.first_seen) : new Date();
      records.push({
        hash: item.sha256_hash,
        firstSeen,
        fileType: item.file_type ?? null,
        signature: item.signature ?? null,
        tags: item.tags ?? [],
      });
    }

    return {
      records,
      checkpoint: new Date().toISOString(),
      warnings: payload.query_status === "ok" ? [] : [`MalwareBazaar query status: ${payload.query_status ?? "unknown"}`],
    };
  }

  normalize(record: MalwareBazaarRecord, context: AdapterContext): NormalizedIndicatorInput {
    void context;
    const normalizedValue = normalizeIndicatorValue("FILE_HASH_SHA256", record.hash);
    const confidence = calculateConfidence({
      source: this.source,
      firstSeen: record.firstSeen,
      lastSeen: record.firstSeen,
      severity: "HIGH" satisfies Severity,
    });

    return {
      type: "FILE_HASH_SHA256",
      value: record.hash,
      normalizedValue,
      confidence,
      severity: "HIGH",
      firstSeen: record.firstSeen,
      lastSeen: record.firstSeen,
      expiresAt: calculateExpirationDate("FILE_HASH_SHA256", record.firstSeen, this.config),
      source: this.source,
      description: record.signature,
      tags: [...record.tags, "malwarebazaar"],
      metadata: {
        fileType: record.fileType,
      },
    };
  }

  async health(): Promise<ThreatFeedAdapterHealth> {
    if (!this.config.feeds.malwareBazaarAuthKey) {
      return { ok: false, message: "MalwareBazaar auth key missing" };
    }

    try {
      await fetchJsonWithRetry<MalwareBazaarResponse>({
        url: "https://mb-api.abuse.ch/api/v1/",
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "Auth-Key": this.config.feeds.malwareBazaarAuthKey,
        },
        body: "query=get_recent&selector=time",
        timeoutMs: this.config.ingestion.timeoutMs,
        maxRetries: 1,
        baseBackoffMs: this.config.ingestion.baseBackoffMs,
      });

      return { ok: true, message: "MalwareBazaar reachable" };
    } catch (error) {
      return {
        ok: false,
        message: error instanceof Error ? error.message : "MalwareBazaar health check failed",
      };
    }
  }
}
