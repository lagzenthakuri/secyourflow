import { NextResponse } from "next/server";
import { ZodError } from "zod";
import { cveIdSchema } from "../domain/schemas";
import { parseSearchQuery } from "../domain/query";
import type { SearchQuery } from "../domain/types";

const CACHE_HEADERS = {
  "Cache-Control": "private, no-store, no-cache, must-revalidate, max-age=0",
};

export function parseSearchQueryFromUrl(url: string): SearchQuery {
  const requestUrl = new URL(url);
  return parseSearchQuery(requestUrl.searchParams);
}

export function parseCveId(value: string): string {
  return cveIdSchema.parse(value.toUpperCase());
}

export function jsonResponse<T>(data: T, status = 200): NextResponse<T> {
  return NextResponse.json(data, {
    status,
    headers: CACHE_HEADERS,
  });
}

export function badRequest(message: string, issues?: unknown): NextResponse {
  return NextResponse.json(
    {
      error: "Invalid request",
      message,
      issues,
    },
    { status: 400 },
  );
}

export function notFound(message: string): NextResponse {
  return NextResponse.json(
    {
      error: "Not found",
      message,
    },
    { status: 404 },
  );
}

export function internalServerError(requestId: string): NextResponse {
  return NextResponse.json(
    {
      error: "Internal server error",
      requestId,
    },
    { status: 500 },
  );
}

export function toRequestErrorMessage(error: unknown): { message: string; issues?: unknown } {
  if (error instanceof ZodError) {
    return {
      message: "Input validation failed",
      issues: error.issues,
    };
  }

  if (error instanceof Error) {
    return {
      message: error.message,
    };
  }

  return {
    message: "Unknown request error",
  };
}
