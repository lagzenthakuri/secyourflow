interface MetricEntry {
  count: number;
  totalMs: number;
}

const counters = new Map<string, number>();
const timings = new Map<string, MetricEntry>();

export function incrementCounter(name: string, value = 1): void {
  counters.set(name, (counters.get(name) ?? 0) + value);
}

export function recordTiming(name: string, ms: number): void {
  const entry = timings.get(name) ?? { count: 0, totalMs: 0 };
  timings.set(name, {
    count: entry.count + 1,
    totalMs: entry.totalMs + ms,
  });
}

export function getMetricsSnapshot(): {
  counters: Record<string, number>;
  timings: Record<string, { count: number; avgMs: number }>;
} {
  const timingSnapshot: Record<string, { count: number; avgMs: number }> = {};

  for (const [name, entry] of timings.entries()) {
    timingSnapshot[name] = {
      count: entry.count,
      avgMs: entry.count > 0 ? Number((entry.totalMs / entry.count).toFixed(2)) : 0,
    };
  }

  return {
    counters: Object.fromEntries(counters.entries()),
    timings: timingSnapshot,
  };
}

export function resetMetrics(): void {
  counters.clear();
  timings.clear();
}
