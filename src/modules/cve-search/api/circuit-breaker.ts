interface CircuitState {
  failures: number;
  openUntil: number;
}

export class CircuitBreakerRegistry {
  private readonly state = new Map<string, CircuitState>();

  constructor(
    private readonly failureThreshold: number,
    private readonly openMs: number,
    private readonly now: () => number = Date.now,
  ) {}

  isOpen(source: string): boolean {
    const entry = this.state.get(source);
    if (!entry) return false;
    return entry.openUntil > this.now();
  }

  recordSuccess(source: string): void {
    this.state.set(source, { failures: 0, openUntil: 0 });
  }

  recordFailure(source: string): void {
    const current = this.state.get(source) ?? { failures: 0, openUntil: 0 };
    const failures = current.failures + 1;

    if (failures >= this.failureThreshold) {
      this.state.set(source, {
        failures,
        openUntil: this.now() + this.openMs,
      });
      return;
    }

    this.state.set(source, {
      failures,
      openUntil: current.openUntil,
    });
  }
}
