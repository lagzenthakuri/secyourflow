import type { CveSearchConfig } from "../domain/types";

const MINUTE = 60_000;
const HOUR = 60 * MINUTE;

function parseNumber(value: string | undefined, fallback: number): number {
  if (!value) return fallback;
  const parsed = Number(value);
  return Number.isFinite(parsed) && parsed > 0 ? parsed : fallback;
}

function parseBoolean(value: string | undefined, fallback: boolean): boolean {
  if (!value) return fallback;
  const normalized = value.trim().toLowerCase();
  if (normalized === "1" || normalized === "true" || normalized === "yes" || normalized === "on") {
    return true;
  }
  if (normalized === "0" || normalized === "false" || normalized === "no" || normalized === "off") {
    return false;
  }
  return fallback;
}

export function getCveSearchConfig(): CveSearchConfig {
  return {
    nvdApiBaseUrl:
      process.env.CVE_NVD_BASE_URL ?? "https://services.nvd.nist.gov/rest/json/cves/2.0",
    mitreApiBaseUrl:
      process.env.CVE_MITRE_BASE_URL ?? "https://cveawg.mitre.org/api/cve",
    cisaKevUrl:
      process.env.CVE_KEV_URL ??
      "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json",
    epssApiBaseUrl: process.env.CVE_EPSS_BASE_URL ?? "https://api.first.org/data/v1/epss",
    enrichment: {
      enabled: parseBoolean(process.env.CVE_ENABLE_ENRICHMENT, true),
    },
    timeouts: {
      perSourceMs: parseNumber(process.env.CVE_PER_SOURCE_TIMEOUT_MS, 6_000),
      overallRequestMs: parseNumber(process.env.CVE_OVERALL_TIMEOUT_MS, 8_000),
    },
    retries: {
      maxRetries: parseNumber(process.env.CVE_MAX_RETRIES, 2),
      baseBackoffMs: parseNumber(process.env.CVE_BACKOFF_MS, 200),
    },
    circuitBreaker: {
      failureThreshold: parseNumber(process.env.CVE_CIRCUIT_FAILURE_THRESHOLD, 3),
      openMs: parseNumber(process.env.CVE_CIRCUIT_OPEN_MS, MINUTE),
    },
    cacheTtlMs: {
      searchResults: parseNumber(process.env.CVE_CACHE_SEARCH_TTL_MS, 10 * MINUTE),
      cveById: parseNumber(process.env.CVE_CACHE_BY_ID_TTL_MS, 60 * MINUTE),
      kevCatalog: parseNumber(process.env.CVE_CACHE_KEV_TTL_MS, 24 * HOUR),
      epssScores: parseNumber(process.env.CVE_CACHE_EPSS_TTL_MS, 12 * HOUR),
    },
  };
}
