import type { NormalizedCve } from "../domain/types";

export function elapsedMs(startedAt: number): number {
  return Date.now() - startedAt;
}

export function createAbortController(
  timeoutMs: number,
): { signal: AbortSignal; dispose: () => void } {
  const controller = new AbortController();
  const timeout = setTimeout(() => {
    controller.abort(new Error(`Overall request timed out after ${timeoutMs}ms`));
  }, timeoutMs);

  return {
    signal: controller.signal,
    dispose: () => clearTimeout(timeout),
  };
}

export function collectSourceValues(
  results: Array<{ source: string; value: NormalizedCve[]; warnings: string[] } | null>,
  warnings: string[],
  sourcesUsed: Set<string>,
): NormalizedCve[] {
  const values: NormalizedCve[] = [];

  for (const result of results) {
    if (!result) {
      warnings.push("source unavailable");
      continue;
    }

    sourcesUsed.add(result.source.toUpperCase());
    warnings.push(...result.warnings.map((warning) => `${result.source}: ${warning}`));
    values.push(...result.value);
  }

  return values;
}
