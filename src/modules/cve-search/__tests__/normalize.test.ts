import { describe, expect, it } from "vitest";
import {
  chooseBetterSeverity,
  createBaseNormalizedCve,
  mergeAttributions,
  nonEmpty,
  normalizeCveId,
  normalizeCveTitle,
  parseIsoOrNull,
  severityFromCvss,
  severityFromText,
  severityWeight,
  titleFromDescription,
} from "../domain/normalize";

describe("domain/normalize", () => {
  it("normalizes cve id", () => {
    expect(normalizeCveId(" cve-2024-1001 ")).toBe("CVE-2024-1001");
  });

  it("maps cvss to severity", () => {
    expect(severityFromCvss(9.9)).toBe("CRITICAL");
    expect(severityFromCvss(8.1)).toBe("HIGH");
    expect(severityFromCvss(5)).toBe("MEDIUM");
    expect(severityFromCvss(2)).toBe("LOW");
    expect(severityFromCvss(null)).toBe("UNKNOWN");
  });

  it("maps text to severity", () => {
    expect(severityFromText("critical")).toBe("CRITICAL");
    expect(severityFromText("moderate")).toBe("MEDIUM");
    expect(severityFromText(undefined)).toBe("UNKNOWN");
  });

  it("chooses higher severity weight", () => {
    expect(chooseBetterSeverity("HIGH", "CRITICAL")).toBe("CRITICAL");
    expect(chooseBetterSeverity("MEDIUM", "LOW")).toBe("MEDIUM");
    expect(severityWeight("UNKNOWN")).toBe(0);
  });

  it("creates base normalized cve", () => {
    const base = createBaseNormalizedCve("cve-2024-1001");
    expect(base.cveId).toBe("CVE-2024-1001");
    expect(base.description).toBe("");
    expect(base.kev.isKnownExploited).toBe(false);
  });

  it("merges attributions without duplicates", () => {
    const merged = mergeAttributions(
      [{ source: "NVD", url: "https://nvd" }],
      [
        { source: "NVD", url: "https://nvd" },
        { source: "MITRE", url: "https://cve.org" },
      ],
    );

    expect(merged).toHaveLength(2);
  });

  it("parses iso and non-empty helper", () => {
    expect(parseIsoOrNull("2024-11-10")).toBe("2024-11-10T00:00:00.000Z");
    expect(nonEmpty("   ")).toBeNull();
    expect(nonEmpty("  value ")).toBe("value");
  });

  it("builds fallback titles from descriptions", () => {
    expect(titleFromDescription("Open redirect in auth callback handling for modern web applications.")).toBe(
      "Open redirect in auth callback handling for modern web applications",
    );
  });

  it("normalizes title with description fallback and cve fallback", () => {
    expect(
      normalizeCveTitle(null, "Arbitrary code execution in parser component for plugin loader", "cve-2024-1001"),
    ).toBe("Arbitrary code execution in parser component for plugin loader");
    expect(normalizeCveTitle(null, "!!!", "cve-2024-1002")).toBe("CVE-2024-1002");
    expect(normalizeCveTitle(" Provided Title ", "ignored", "cve-2024-1003")).toBe("Provided Title");
  });
});
