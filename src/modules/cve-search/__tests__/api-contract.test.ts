import { describe, expect, it } from "vitest";
import { http, HttpResponse } from "msw";
import { GET as getSearch } from "@/app/api/cves/search/route";
import { GET as getDetail } from "@/app/api/cves/[cveId]/route";
import { POST as postSearch } from "@/app/api/cves/search/route";
import { resetCveSearchServiceSingleton } from "../api/service";
import { detailResponseSchema, searchResponseSchema } from "../domain/schemas";
import { nvdSearchFixture } from "./fixtures/synthetic-cves";
import { server } from "../../../../vitest.setup";

function setTestEnv(): void {
  process.env.CVE_NVD_BASE_URL = "https://nvd.test/rest/json/cves/2.0";
}

describe("api contract", () => {
  it("validates /api/cves/search response shape", async () => {
    setTestEnv();
    resetCveSearchServiceSingleton();

    server.use(http.get("https://nvd.test/rest/json/cves/2.0", () => HttpResponse.json(nvdSearchFixture)));

    const response = await getSearch(new Request("https://app.test/api/cves/search?q=CVE-2024-1001"));
    expect(response.status).toBe(200);

    const json = await response.json();
    const parsed = searchResponseSchema.safeParse(json);
    expect(parsed.success).toBe(true);
  });

  it("validates POST /api/cves/search response shape", async () => {
    setTestEnv();
    resetCveSearchServiceSingleton();

    server.use(http.get("https://nvd.test/rest/json/cves/2.0", () => HttpResponse.json(nvdSearchFixture)));

    const response = await postSearch(new Request("https://app.test/api/cves/search?q=CVE-2024-1001", { method: "POST" }));
    expect(response.status).toBe(200);

    const json = await response.json();
    const parsed = searchResponseSchema.safeParse(json);
    expect(parsed.success).toBe(true);
  });

  it("validates /api/cves/:id response shape", async () => {
    setTestEnv();
    resetCveSearchServiceSingleton();

    server.use(http.get("https://nvd.test/rest/json/cves/2.0", () => HttpResponse.json(nvdSearchFixture)));

    const response = await getDetail(new Request("https://app.test/api/cves/CVE-2024-1001"), {
      params: Promise.resolve({ cveId: "CVE-2024-1001" }),
    });

    expect(response.status).toBe(200);

    const json = await response.json();
    const parsed = detailResponseSchema.safeParse(json);
    expect(parsed.success).toBe(true);
  });

  it("returns 400 on invalid query and 404 when cve missing", async () => {
    setTestEnv();
    resetCveSearchServiceSingleton();

    server.use(http.get("https://nvd.test/rest/json/cves/2.0", () => HttpResponse.json({ vulnerabilities: [] })));

    const bad = await getSearch(
      new Request("https://app.test/api/cves/search?from=2024-12-31T00:00:00.000Z&to=2024-01-01T00:00:00.000Z"),
    );
    expect(bad.status).toBe(400);

    const missing = await getDetail(new Request("https://app.test/api/cves/CVE-2024-9999"), {
      params: Promise.resolve({ cveId: "CVE-2024-9999" }),
    });
    expect(missing.status).toBe(404);
  });
});
