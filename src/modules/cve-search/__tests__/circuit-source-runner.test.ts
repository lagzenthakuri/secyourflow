import { describe, expect, it } from "vitest";
import { CircuitBreakerRegistry } from "../api/circuit-breaker";
import { runSourceCall } from "../api/source-runner";

describe("api/circuit-breaker and source-runner", () => {
  it("opens circuit after repeated failures", async () => {
    let now = 0;
    const circuit = new CircuitBreakerRegistry(2, 100, () => now);

    const first = await runSourceCall({
      source: "nvd",
      circuit,
      action: async () => {
        throw new Error("boom");
      },
    });

    const second = await runSourceCall({
      source: "nvd",
      circuit,
      action: async () => {
        throw new Error("boom");
      },
    });

    expect(first).toBeNull();
    expect(second).toBeNull();
    expect(circuit.isOpen("nvd")).toBe(true);

    const skipped = await runSourceCall({
      source: "nvd",
      circuit,
      action: async () => ({ value: 1 }),
    });

    expect(skipped).toBeNull();

    now = 200;
    const recovered = await runSourceCall({
      source: "nvd",
      circuit,
      action: async () => ({ value: 42 }),
    });

    expect(recovered?.value).toBe(42);
    expect(circuit.isOpen("nvd")).toBe(false);
  });
});
