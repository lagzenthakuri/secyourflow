import { delay, http, HttpResponse } from "msw";
import { describe, expect, it } from "vitest";
import { CveSearchService } from "../api/service";
import { nvdSearchFixture } from "./fixtures/synthetic-cves";
import { createTestConfig } from "./integration-helpers";
import { server } from "../../../../vitest.setup";

function buildNvdDataset(total: number, keyword: string): Array<{ cve: Record<string, unknown> }> {
  return Array.from({ length: total }, (_, index) => {
    const sequence = total - index;
    const cveId = `CVE-2024-${String(10_000 + sequence)}`;
    const iso = new Date(Date.UTC(2024, 0, sequence)).toISOString();

    return {
      cve: {
        id: cveId,
        published: iso,
        lastModified: iso,
        descriptions: [{ lang: "en", value: `${keyword} vulnerability ${sequence}` }],
        references: [{ url: `https://example.test/${keyword}/${sequence}`, source: "NVD" }],
        metrics: {
          cvssMetricV31: [
            {
              cvssData: {
                baseSeverity: "MEDIUM",
                baseScore: 5.5,
                vectorString: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:N",
                version: "3.1",
              },
            },
          ],
        },
        configurations: [],
      },
    };
  });
}

function buildNvdItem(
  cveId: string,
  description: string,
  options?: { cpe?: string[]; references?: string[] },
): { cve: Record<string, unknown> } {
  return {
    cve: {
      id: cveId,
      published: "2024-01-01T00:00:00.000Z",
      lastModified: "2024-01-02T00:00:00.000Z",
      descriptions: [{ lang: "en", value: description }],
      references: (options?.references ?? [`https://example.test/${cveId.toLowerCase()}`]).map((url) => ({
        url,
        source: "NVD",
      })),
      metrics: {
        cvssMetricV31: [
          {
            cvssData: {
              baseSeverity: "HIGH",
              baseScore: 7.5,
              vectorString: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
              version: "3.1",
            },
          },
        ],
      },
      configurations: [
        {
          nodes: [
            {
              cpeMatch: (options?.cpe ?? []).map((criteria) => ({
                vulnerable: true,
                criteria,
              })),
            },
          ],
        },
      ],
    },
  };
}

describe("service integration", () => {
  it("returns NVD search results on 200 responses", async () => {
    server.use(http.get("https://nvd.test/rest/json/cves/2.0", () => HttpResponse.json(nvdSearchFixture)));

    const service = new CveSearchService(createTestConfig());
    const response = await service.search({
      q: "CVE-2024-1001",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    expect(response.data.length).toBeGreaterThan(0);
    expect(response.data[0].cveId).toBe("CVE-2024-1001");
    expect(response.meta.partial).toBe(false);
    expect(response.meta.sourcesUsed).toEqual(["NVD"]);
  });

  it("returns expected CVE with no warnings when NVD succeeds", async () => {
    server.use(http.get("https://nvd.test/rest/json/cves/2.0", () => HttpResponse.json(nvdSearchFixture)));

    const service = new CveSearchService(createTestConfig());
    const response = await service.search({
      q: "CVE-2024-1002",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    expect(response.data.some((item) => item.cveId === "CVE-2024-1002")).toBe(true);
    expect(response.meta.warnings).toEqual([]);
  });

  it("derives missing titles from description during normalization", async () => {
    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", () =>
        HttpResponse.json({
          vulnerabilities: [
            buildNvdItem(
              "CVE-2024-4444",
              "Open redirect vulnerability in react-dev-utils package for build tooling.",
            ),
          ],
        }),
      ),
    );

    const service = new CveSearchService(createTestConfig());
    const response = await service.search({
      q: "react-dev-utils",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    expect(response.data[0]?.title).toBe(
      "Open redirect vulnerability in react-dev-utils package for build tooling",
    );
  });

  it("retries 429 and succeeds", async () => {
    let nvdCalls = 0;

    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", () => {
        nvdCalls += 1;
        if (nvdCalls === 1) {
          return HttpResponse.json({ error: "rate limited" }, { status: 429, headers: { "Retry-After": "0" } });
        }
        return HttpResponse.json(nvdSearchFixture);
      }),
    );

    const service = new CveSearchService(createTestConfig());
    const response = await service.search({
      q: "CVE-2024-1001",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    expect(nvdCalls).toBe(2);
    expect(response.data.length).toBeGreaterThan(0);
  });

  it("returns partial results on upstream 500", async () => {
    server.use(http.get("https://nvd.test/rest/json/cves/2.0", () => HttpResponse.json({ error: "boom" }, { status: 500 })));

    const service = new CveSearchService(createTestConfig());
    const response = await service.search({
      q: "CVE-2024-1003",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    expect(response.meta.partial).toBe(true);
    expect(response.meta.warnings.length).toBeGreaterThan(0);
    expect(response.data).toEqual([]);
  });

  it("returns partial results on upstream timeout", async () => {
    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", async () => {
        await delay(120);
        return HttpResponse.json(nvdSearchFixture);
      }),
    );

    const service = new CveSearchService(
      createTestConfig({
        timeouts: {
          perSourceMs: 30,
          overallRequestMs: 1_500,
        },
      }),
    );

    const response = await service.search({
      q: "CVE-2024-1003",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    expect(response.meta.partial).toBe(true);
    expect(response.data).toEqual([]);
  });

  it("returns empty response when NVD payload contains no vulnerabilities", async () => {
    server.use(http.get("https://nvd.test/rest/json/cves/2.0", () => HttpResponse.json({ malformed: true })));

    const service = new CveSearchService(createTestConfig());
    const response = await service.search({
      q: "CVE-2024-1001",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    expect(response.data).toEqual([]);
    expect(response.meta.partial).toBe(false);
    expect(response.meta.warnings).toEqual([]);
  });

  it("coalesces identical in-flight queries into one upstream call", async () => {
    let nvdCalls = 0;

    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", async () => {
        nvdCalls += 1;
        await delay(40);
        return HttpResponse.json(nvdSearchFixture);
      }),
    );

    const service = new CveSearchService(createTestConfig());
    const query = {
      q: "CVE-2024-1001",
      page: 1,
      pageSize: 20,
      sort: "relevance" as const,
    };

    const [first, second] = await Promise.all([service.search(query), service.search(query)]);

    expect(nvdCalls).toBe(1);
    expect(first.data[0].cveId).toBe(second.data[0].cveId);
  });

  it("passes the exact non-empty query string to NVD", async () => {
    let requestedKeyword: string | null = null;
    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", ({ request }) => {
        requestedKeyword = new URL(request.url).searchParams.get("keywordSearch");
        return HttpResponse.json(nvdSearchFixture);
      }),
    );

    const service = new CveSearchService(createTestConfig());
    await service.search({
      q: "openssl",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    expect(requestedKeyword).toBe("openssl");
  });

  it("uses cveId upstream lookup for exact CVE-ID queries", async () => {
    let requestedCveId: string | null = null;
    let requestedKeyword: string | null = null;

    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", ({ request }) => {
        const url = new URL(request.url);
        requestedCveId = url.searchParams.get("cveId");
        requestedKeyword = url.searchParams.get("keywordSearch");

        return HttpResponse.json({
          vulnerabilities: [
            buildNvdItem(
              "CVE-2018-6341",
              "Cross-site scripting vulnerability in React application components",
            ),
          ],
        });
      }),
    );

    const service = new CveSearchService(createTestConfig());
    const response = await service.search({
      q: "CVE-2018-6341",
      page: 1,
      pageSize: 20,
      sort: "relevance",
      mode: "auto",
    });

    expect(requestedCveId).toBe("CVE-2018-6341");
    expect(requestedKeyword).toBeNull();
    expect(response.data[0]?.cveId).toBe("CVE-2018-6341");
  });

  it("excludes ReactOS/Reactor collisions in product mode for React", async () => {
    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", ({ request }) => {
        const url = new URL(request.url);
        expect(url.searchParams.get("keywordSearch")).toBe("react");

        return HttpResponse.json({
          vulnerabilities: [
            buildNvdItem(
              "CVE-2007-1724",
              "ReactOS kernel privilege escalation vulnerability",
              {
                cpe: ["cpe:2.3:o:reactos:reactos:*:*:*:*:*:*:*:*"],
              },
            ),
            buildNvdItem(
              "CVE-2020-5403",
              "Reactor Netty request smuggling vulnerability",
              {
                cpe: ["cpe:2.3:a:pivotal:reactor_netty:*:*:*:*:*:*:*:*"],
              },
            ),
            buildNvdItem(
              "CVE-2018-6341",
              "React application XSS through react-dev-utils handling",
              {
                cpe: ["cpe:2.3:a:facebook:react:*:*:*:*:*:*:*:*"],
                references: ["https://github.com/facebook/react/issues/12345"],
              },
            ),
          ],
        });
      }),
    );

    const service = new CveSearchService(createTestConfig());
    const response = await service.search({
      q: "React",
      mode: "product",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    expect(response.data.map((entry) => entry.cveId)).toEqual(["CVE-2018-6341"]);
  });

  it("returns ReactOS results when ReactOS is searched explicitly", async () => {
    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", ({ request }) => {
        const url = new URL(request.url);
        expect(url.searchParams.get("keywordSearch")).toBe("reactos");

        return HttpResponse.json({
          vulnerabilities: [
            buildNvdItem(
              "CVE-2007-1724",
              "ReactOS local privilege escalation in kernel subsystem",
              {
                cpe: ["cpe:2.3:o:reactos:reactos:*:*:*:*:*:*:*:*"],
              },
            ),
            buildNvdItem(
              "CVE-2018-6341",
              "React application XSS through react-dev-utils handling",
              {
                cpe: ["cpe:2.3:a:facebook:react:*:*:*:*:*:*:*:*"],
              },
            ),
          ],
        });
      }),
    );

    const service = new CveSearchService(createTestConfig());
    const response = await service.search({
      q: "ReactOS",
      mode: "product",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    expect(response.data.map((entry) => entry.cveId)).toEqual(["CVE-2007-1724"]);
  });

  it("returns react-dev-utils package related CVEs in auto/product mode", async () => {
    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", ({ request }) => {
        const url = new URL(request.url);
        expect(url.searchParams.get("keywordSearch")).toBe("react-dev-utils");

        return HttpResponse.json({
          vulnerabilities: [
            buildNvdItem(
              "CVE-2018-6342",
              "react-dev-utils exposes unsafe source-map handling in React build pipelines",
              {
                cpe: ["cpe:2.3:a:facebook:react:*:*:*:*:*:*:*:*"],
                references: ["https://github.com/facebook/create-react-app/tree/main/packages/react-dev-utils"],
              },
            ),
            buildNvdItem(
              "CVE-2020-5403",
              "Reactor Netty request smuggling vulnerability",
            ),
          ],
        });
      }),
    );

    const service = new CveSearchService(createTestConfig());
    const response = await service.search({
      q: "react-dev-utils",
      page: 1,
      pageSize: 20,
      sort: "relevance",
      mode: "auto",
    });

    expect(response.data.map((entry) => entry.cveId)).toEqual(["CVE-2018-6342"]);
  });

  it("uses text mode for multi-word auto queries and keeps broad text matches", async () => {
    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", ({ request }) => {
        const url = new URL(request.url);
        expect(url.searchParams.get("keywordSearch")).toBe("open redirect");
        expect(url.searchParams.get("cveId")).toBeNull();

        return HttpResponse.json({
          vulnerabilities: [
            buildNvdItem(
              "CVE-2024-8101",
              "Open redirect vulnerability in callback parameter handling",
            ),
            buildNvdItem(
              "CVE-2024-8102",
              "Validation bypass can redirect users to open external targets",
            ),
          ],
        });
      }),
    );

    const service = new CveSearchService(createTestConfig());
    const response = await service.search({
      q: "open redirect",
      mode: "auto",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    expect(response.data.map((entry) => entry.cveId)).toEqual(
      expect.arrayContaining(["CVE-2024-8101", "CVE-2024-8102"]),
    );
    expect(response.data.length).toBe(2);
  });

  it("does not reuse cached search results across different queries", async () => {
    let nvdCalls = 0;

    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", ({ request }) => {
        nvdCalls += 1;
        const url = new URL(request.url);
        const keyword = url.searchParams.get("keywordSearch");

        if (keyword === "react") {
          return HttpResponse.json({
            vulnerabilities: [
              {
                cve: {
                  id: "CVE-2024-2201",
                  published: "2024-03-10T00:00:00.000Z",
                  lastModified: "2024-03-12T00:00:00.000Z",
                  descriptions: [{ lang: "en", value: "react renderer privilege escalation" }],
                  references: [{ url: "https://example.test/react", source: "NVD" }],
                  metrics: {
                    cvssMetricV31: [
                      {
                        cvssData: {
                          baseSeverity: "HIGH",
                          baseScore: 8.1,
                          vectorString: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
                          version: "3.1",
                        },
                      },
                    ],
                  },
                },
              },
            ],
          });
        }

        if (keyword === "openssl") {
          return HttpResponse.json({
            vulnerabilities: [
              {
                cve: {
                  id: "CVE-2024-3301",
                  published: "2024-04-10T00:00:00.000Z",
                  lastModified: "2024-04-12T00:00:00.000Z",
                  descriptions: [{ lang: "en", value: "openssl certificate bypass" }],
                  references: [{ url: "https://example.test/openssl", source: "NVD" }],
                  metrics: {
                    cvssMetricV31: [
                      {
                        cvssData: {
                          baseSeverity: "HIGH",
                          baseScore: 7.8,
                          vectorString: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
                          version: "3.1",
                        },
                      },
                    ],
                  },
                },
              },
            ],
          });
        }

        return HttpResponse.json({ vulnerabilities: [] });
      }),
    );

    const service = new CveSearchService(createTestConfig());

    const react = await service.search({
      q: "react",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    const openssl = await service.search({
      q: "openssl",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    const reactAgain = await service.search({
      q: "react",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    expect(react.data[0]?.cveId).toBe("CVE-2024-2201");
    expect(openssl.data[0]?.cveId).toBe("CVE-2024-3301");
    expect(reactAgain.data[0]?.cveId).toBe("CVE-2024-2201");
    expect(react.data[0]?.cveId).not.toBe(openssl.data[0]?.cveId);
    expect(nvdCalls).toBe(2);
  });

  it("keeps paginated results contiguous without skipping intermediate matches", async () => {
    const keyword = "contiguous-pagination";
    const vulnerabilities = buildNvdDataset(120, keyword);
    const requestedStartIndexes: number[] = [];

    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", ({ request }) => {
        const url = new URL(request.url);
        const startIndex = Number(url.searchParams.get("startIndex") ?? "0");
        const resultsPerPage = Number(url.searchParams.get("resultsPerPage") ?? "20");
        requestedStartIndexes.push(startIndex);

        expect(url.searchParams.get("keywordSearch")).toBe(keyword);

        return HttpResponse.json({
          vulnerabilities: vulnerabilities.slice(startIndex, startIndex + resultsPerPage),
        });
      }),
    );

    const service = new CveSearchService(createTestConfig());

    const pageOne = await service.search({
      q: keyword,
      page: 1,
      pageSize: 20,
      sort: "newest",
    });

    const pageTwo = await service.search({
      q: keyword,
      page: 2,
      pageSize: 20,
      sort: "newest",
    });

    const expectedOrderedIds = vulnerabilities.map((entry) => String(entry.cve.id));

    expect(pageOne.data.map((entry) => entry.cveId)).toEqual(expectedOrderedIds.slice(0, 20));
    expect(pageTwo.data.map((entry) => entry.cveId)).toEqual(expectedOrderedIds.slice(20, 40));
    expect(requestedStartIndexes).toEqual([0, 0]);
  });

  it("labels empty-query searches as trending/recent results", async () => {
    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", () => HttpResponse.json(nvdSearchFixture)),
    );

    const service = new CveSearchService(createTestConfig());
    const response = await service.search({
      q: "",
      page: 1,
      pageSize: 20,
      sort: "relevance",
    });

    expect(response.meta.warnings).toContain("trending/recent results shown because query is empty");
    expect(response.meta.partial).toBe(true);
  });

  it("returns detail by id", async () => {
    server.use(http.get("https://nvd.test/rest/json/cves/2.0", () => HttpResponse.json(nvdSearchFixture)));

    const service = new CveSearchService(createTestConfig());
    const detail = await service.getById("CVE-2024-1001");

    expect(detail?.data.cveId).toBe("CVE-2024-1001");
    expect(detail?.meta.sourcesUsed).toEqual(["NVD"]);
  });
});
