import { describe, expect, it } from "vitest";
import { normalizeSearchQueryKey, parseSearchQuery } from "../domain/query";

describe("domain/query", () => {
  it("parses search params with aliases", () => {
    const params = new URLSearchParams({
      q: "openssl",
      mode: "product",
      page: "2",
      pageSize: "30",
      sort: "cvss_desc",
      epss_risk: "HIGH",
      published_from: "2024-01-01",
      published_to: "2024-12-31",
    });

    const query = parseSearchQuery(params);
    expect(query.q).toBe("openssl");
    expect(query.mode).toBe("product");
    expect(query.page).toBe(2);
    expect(query.pageSize).toBe(30);
    expect(query.sort).toBe("cvss");
    expect(query.epssMin).toBe(0.7);
    expect(query.epssMax).toBe(1);
    expect(query.from).toContain("2024-01-01");
  });

  it("derives date range from year presets", () => {
    const params = new URLSearchParams({
      q: "openssl",
      year: "2010s",
    });

    const query = parseSearchQuery(params);
    expect(query.from).toContain("2010-01-01");
    expect(query.to).toContain("2019-12-31");
  });

  it("normalizes query key order", () => {
    const first = normalizeSearchQueryKey({ q: "A", page: 1, pageSize: 20, sort: "relevance" });
    const second = normalizeSearchQueryKey({ q: "a", page: 1, pageSize: 20, sort: "relevance" });

    expect(first).toBe(second);
  });

  it("falls back to auto mode when mode is invalid", () => {
    const params = new URLSearchParams({
      q: "react",
      mode: "unknown",
    });

    const query = parseSearchQuery(params);
    expect(query.mode).toBe("auto");
  });
});
