import { describe, expect, it } from "vitest";
import { dedupeAndMergeCves } from "../domain/dedupe";
import { createSyntheticCve } from "./fixtures/synthetic-cves";

describe("domain/dedupe", () => {
  it("deduplicates CVEs and preserves strongest fields", () => {
    const first = createSyntheticCve({
      cveId: "CVE-2024-1001",
      description: "Short desc",
      cvss: 7.4,
      epss: 0.1,
      kev: false,
      modified: "2024-01-01T00:00:00.000Z",
    });

    const second = createSyntheticCve({
      cveId: "CVE-2024-1001",
      description: "Longer and richer description for analysts",
      cvss: 9.8,
      epss: 0.98,
      kev: true,
      modified: "2024-02-01T00:00:00.000Z",
    });

    second.references.push({ url: "https://extra-ref", source: "extra" });

    const result = dedupeAndMergeCves([first, second]);

    expect(result).toHaveLength(1);
    expect(result[0].description).toContain("richer");
    expect(result[0].cvss.baseScore).toBe(9.8);
    expect(result[0].epss.score).toBe(0.98);
    expect(result[0].kev.isKnownExploited).toBe(true);
    expect(result[0].references).toHaveLength(2);
    expect(result[0].lastModified).toBe("2024-02-01T00:00:00.000Z");
  });

  it("returns unique cves untouched when no duplicates", () => {
    const result = dedupeAndMergeCves([
      createSyntheticCve({ cveId: "CVE-2024-1001" }),
      createSyntheticCve({ cveId: "CVE-2024-1002" }),
    ]);

    expect(result).toHaveLength(2);
  });
});
