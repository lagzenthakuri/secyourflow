import { describe, expect, it } from "vitest";
import { http, HttpResponse } from "msw";
import { server } from "../../../../vitest.setup";
import { NvdAdapter } from "../adapters/nvd-adapter";
import { createTestConfig } from "./integration-helpers";

describe("nvd adapter query handling", () => {
  it("uses cveId for CVE lookups and filters out non-matching results", async () => {
    const config = createTestConfig();

    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", ({ request }) => {
        const url = new URL(request.url);
        expect(url.searchParams.get("cveId")).toBe("CVE-2024-9999");
        expect(url.searchParams.get("keywordSearch")).toBeNull();

        return HttpResponse.json({
          vulnerabilities: [
            {
              cve: {
                id: "CVE-2024-9999",
                descriptions: [{ lang: "en", value: "target cve" }],
                references: [{ url: "https://example.test/target", source: "NVD" }],
              },
            },
            {
              cve: {
                id: "CVE-2024-1234",
                descriptions: [{ lang: "en", value: "default page item" }],
                references: [{ url: "https://example.test/random", source: "NVD" }],
              },
            },
          ],
        });
      }),
    );

    const adapter = new NvdAdapter({ config });
    const result = await adapter.search("CVE-2024-9999", { page: 1, pageSize: 20 });

    expect(result.cves).toHaveLength(1);
    expect(result.cves[0].cveId).toBe("CVE-2024-9999");
  });

  it("uses keywordSearch for non-CVE queries", async () => {
    const config = createTestConfig();

    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", ({ request }) => {
        const url = new URL(request.url);
        expect(url.searchParams.get("keywordSearch")).toBe("openssl");
        expect(url.searchParams.get("cveId")).toBeNull();

        return HttpResponse.json({
          vulnerabilities: [
            {
              cve: {
                id: "CVE-2024-3333",
                descriptions: [{ lang: "en", value: "openssl keyword match" }],
                references: [{ url: "https://example.test/openssl", source: "NVD" }],
              },
            },
          ],
        });
      }),
    );

    const adapter = new NvdAdapter({ config });
    const result = await adapter.search("openssl", { page: 1, pageSize: 20 });

    expect(result.cves).toHaveLength(1);
    expect(result.cves[0].description).toContain("openssl");
  });
});
