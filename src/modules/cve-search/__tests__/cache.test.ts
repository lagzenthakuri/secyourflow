import { describe, expect, it, vi } from "vitest";
import { RequestCoalescer, stableCacheKey, TtlCache } from "../cache/memory-cache";

describe("cache/memory-cache", () => {
  it("normalizes stable cache keys regardless of key order", () => {
    const first = stableCacheKey("search", { b: 2, a: 1, nested: { y: 2, x: 1 } });
    const second = stableCacheKey("search", { a: 1, nested: { x: 1, y: 2 }, b: 2 });

    expect(first).toBe(second);
  });

  it("respects ttl and max entries", () => {
    const now = Date.now();
    const cache = new TtlCache<number>(2);
    cache.set("a", 1, 1_000, now);
    cache.set("b", 2, 1_000, now);
    cache.set("c", 3, 1_000, now);

    expect(cache.get("a", now)).toBeUndefined();
    expect(cache.size()).toBe(2);
    expect(cache.get("b", now + 2_000)).toBeUndefined();
  });

  it("coalesces concurrent requests", async () => {
    const coalescer = new RequestCoalescer();
    const fn = vi.fn(async () => {
      await new Promise((resolve) => setTimeout(resolve, 25));
      return "ok";
    });

    const [first, second] = await Promise.all([
      coalescer.run("same-key", fn),
      coalescer.run("same-key", fn),
    ]);

    expect(first).toBe("ok");
    expect(second).toBe("ok");
    expect(fn).toHaveBeenCalledTimes(1);
    expect(coalescer.size()).toBe(0);
  });
});
