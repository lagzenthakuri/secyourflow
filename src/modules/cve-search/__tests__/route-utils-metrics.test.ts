import { ZodError } from "zod";
import { describe, expect, it } from "vitest";
import {
  badRequest,
  internalServerError,
  jsonResponse,
  notFound,
  parseCveId,
  parseSearchQueryFromUrl,
  toRequestErrorMessage,
} from "../api/route-utils";
import {
  getMetricsSnapshot,
  incrementCounter,
  recordTiming,
  resetMetrics,
} from "../api/metrics";

describe("api/route-utils and metrics", () => {
  it("parses search query and cve id", () => {
    const query = parseSearchQueryFromUrl("https://example.com/api/cves/search?q=test&page=2");
    expect(query.q).toBe("test");
    expect(query.page).toBe(2);
    expect(parseCveId("cve-2024-1001")).toBe("CVE-2024-1001");
  });

  it("creates json responses with expected status", async () => {
    const ok = jsonResponse({ ok: true });
    const invalid = badRequest("bad", [{ field: "q" }]);
    const missing = notFound("missing");
    const failed = internalServerError("req-id");

    expect(ok.status).toBe(200);
    expect(invalid.status).toBe(400);
    expect(missing.status).toBe(404);
    expect(failed.status).toBe(500);

    const parsed = await ok.json();
    expect(parsed.ok).toBe(true);
  });

  it("normalizes request errors", () => {
    const zodError = new ZodError([]);
    expect(toRequestErrorMessage(zodError).message).toContain("validation");
    expect(toRequestErrorMessage(new Error("x")).message).toBe("x");
    expect(toRequestErrorMessage("x").message).toContain("Unknown");
  });

  it("tracks counters and timings", () => {
    resetMetrics();
    incrementCounter("a");
    incrementCounter("a", 2);
    recordTiming("search", 100);
    recordTiming("search", 50);

    const snapshot = getMetricsSnapshot();
    expect(snapshot.counters.a).toBe(3);
    expect(snapshot.timings.search.count).toBe(2);
    expect(snapshot.timings.search.avgMs).toBe(75);
  });
});
