import { describe, expect, it } from "vitest";
import { http, HttpResponse } from "msw";
import { server } from "../../../../vitest.setup";
import { MitreAdapter } from "../adapters/mitre-adapter";
import { createTestConfig } from "./integration-helpers";

function mitreRecord(cveId: string): unknown {
  return {
    cveMetadata: {
      cveId,
      state: "PUBLISHED",
      datePublished: "2024-01-10T00:00:00Z",
      dateUpdated: "2024-01-11T00:00:00Z",
    },
    containers: {
      cna: {
        title: "Valid MITRE record",
        descriptions: [{ lang: "en", value: `MITRE description for ${cveId}` }],
        references: [{ url: `https://www.cve.org/CVERecord?id=${cveId}` }],
        metrics: [
          {
            cvssV3_1: {
              baseScore: 8.4,
              baseSeverity: "HIGH",
              vectorString: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
            },
          },
        ],
        affected: [
          {
            vendor: "npm",
            product: "react",
            versions: [{ status: "affected", version: ">=1.0.0", lessThan: "1.2.3" }],
          },
        ],
      },
    },
  };
}

describe("mitre adapter", () => {
  it("maps valid records", async () => {
    const config = createTestConfig();
    server.use(
      http.get("https://mitre.test/api/cve/:cveId", ({ params }) =>
        HttpResponse.json(mitreRecord(String(params.cveId).toUpperCase())),
      ),
    );

    const adapter = new MitreAdapter({ config });
    const result = await adapter.search("CVE-2024-7001", { page: 1, pageSize: 20 });

    expect(result.warnings).toEqual([]);
    expect(result.cves).toHaveLength(1);
    expect(result.cves[0].cveId).toBe("CVE-2024-7001");
    expect(result.cves[0].affected.packages.length).toBeGreaterThan(0);
  });

  it("returns empty list for non-CVE keyword queries", async () => {
    const config = createTestConfig();
    const adapter = new MitreAdapter({ config });
    const result = await adapter.search("openssl", { page: 1, pageSize: 20 });

    expect(result.warnings).toEqual([]);
    expect(result.cves).toEqual([]);
  });

  it("returns empty result for 404 responses", async () => {
    const config = createTestConfig();
    server.use(
      http.get("https://mitre.test/api/cve/:cveId", () => HttpResponse.json({}, { status: 404 })),
    );

    const adapter = new MitreAdapter({ config });
    const result = await adapter.search("CVE-2024-7002", { page: 1, pageSize: 20 });

    expect(result.warnings).toEqual([]);
    expect(result.cves).toEqual([]);
  });

  it("returns warning on validation failure", async () => {
    const config = createTestConfig();
    server.use(
      http.get("https://mitre.test/api/cve/:cveId", () => HttpResponse.json({ unexpected: true })),
    );

    const adapter = new MitreAdapter({ config });
    const result = await adapter.search("CVE-2024-7003", { page: 1, pageSize: 20 });

    expect(result.cves).toEqual([]);
    expect(result.warnings).toEqual(["MITRE CVE API response validation failed"]);
  });

  it("returns warning on 429 responses", async () => {
    const config = createTestConfig();
    server.use(
      http.get("https://mitre.test/api/cve/:cveId", () => HttpResponse.json({}, { status: 429 })),
    );

    const adapter = new MitreAdapter({ config });
    const result = await adapter.search("CVE-2024-7004", { page: 1, pageSize: 20 });

    expect(result.cves).toEqual([]);
    expect(result.warnings).toEqual(["MITRE CVE API rate limited"]);
  });

  it("returns warning on 500 responses", async () => {
    const config = createTestConfig();
    server.use(
      http.get("https://mitre.test/api/cve/:cveId", () => HttpResponse.json({}, { status: 500 })),
    );

    const adapter = new MitreAdapter({ config });
    const result = await adapter.search("CVE-2024-7005", { page: 1, pageSize: 20 });

    expect(result.cves).toEqual([]);
    expect(result.warnings).toEqual(["MITRE CVE API upstream error (500)"]);
  });

  it("maps detail responses through getById", async () => {
    const config = createTestConfig();
    server.use(
      http.get("https://mitre.test/api/cve/:cveId", ({ params }) =>
        HttpResponse.json(mitreRecord(String(params.cveId).toUpperCase())),
      ),
    );

    const adapter = new MitreAdapter({ config });
    const result = await adapter.getById("CVE-2024-7006");

    expect(result.warnings).toEqual([]);
    expect(result.cve?.cveId).toBe("CVE-2024-7006");
  });
});
