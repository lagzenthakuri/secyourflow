import { describe, expect, it } from "vitest";
import { CveSearchService } from "../api/service";

const runIfEnabled = process.env.REAL_API_TESTS === "true" ? it : it.skip;
const REAL_SANITY_IDS = [
  "CVE-1999-0001",
  "CVE-2014-0160",
  "CVE-2017-0144",
  "CVE-2020-1472",
  "CVE-2021-44228",
  "CVE-2024-3094",
] as const;

function isRateLimitedError(error: unknown): boolean {
  const message = error instanceof Error ? error.message.toLowerCase() : String(error).toLowerCase();
  return message.includes("429") || message.includes("rate") || message.includes("too many requests");
}

describe("real api sanity (optional)", () => {
  runIfEnabled("fetches a small cross-year CVE subset from public APIs", async () => {
    const service = new CveSearchService();
    const missing: string[] = [];

    for (const cveId of REAL_SANITY_IDS) {
      try {
        const detail = await service.getById(cveId);
        if (!detail) {
          missing.push(cveId);
          continue;
        }

        expect(detail.data.cveId).toBe(cveId);
        expect(detail.data.description.length).toBeGreaterThan(10);
      } catch (error) {
        if (isRateLimitedError(error)) {
          console.warn(
            "[real-api-sanity] skipped due to rate limiting while calling upstream CVE APIs",
          );
          return;
        }

        throw error;
      }
    }

    expect(missing).toEqual([]);
  }, 40_000);
});
