import { describe, expect, it } from "vitest";
import { http, HttpResponse } from "msw";
import { server } from "../../../../vitest.setup";
import { EpssAdapter } from "../adapters/epss-adapter";
import { KevAdapter } from "../adapters/kev-adapter";
import { MitreAdapter } from "../adapters/mitre-adapter";
import { NvdAdapter } from "../adapters/nvd-adapter";
import { epssFixture, kevFixture, mitreFixtureById, nvdSearchFixture } from "./fixtures/synthetic-cves";
import { createTestConfig } from "./integration-helpers";

describe("adapters integration", () => {
  it("NVD adapter maps search and detail", async () => {
    const config = createTestConfig();
    server.use(
      http.get("https://nvd.test/rest/json/cves/2.0", () => HttpResponse.json(nvdSearchFixture)),
    );

    const adapter = new NvdAdapter({ config });
    const search = await adapter.search("CVE-2024-1001", { page: 1, pageSize: 20 });
    const detail = await adapter.getById("CVE-2024-1001");

    expect(search.cves.length).toBeGreaterThan(0);
    expect(search.cves[0].cveId).toBe("CVE-2024-1001");
    expect(search.cves[0].affected.cpe.length).toBeGreaterThan(0);
    expect(detail.cve?.cveId).toBe("CVE-2024-1001");
  });

  it("MITRE adapter handles 404 and maps search/detail by CVE ID", async () => {
    const config = createTestConfig();

    server.use(
      http.get("https://mitre.test/api/cve/:cveId", ({ params }) => {
        const cveId = String(params.cveId).toUpperCase();
        if (cveId === "CVE-2024-4040") {
          return HttpResponse.json({}, { status: 404 });
        }

        return HttpResponse.json(mitreFixtureById[cveId] ?? {}, {
          status: mitreFixtureById[cveId] ? 200 : 404,
        });
      }),
    );

    const adapter = new MitreAdapter({ config });

    const ok = await adapter.search("CVE-2024-1001", { page: 1, pageSize: 20 });
    const notFound = await adapter.search("CVE-2024-4040", { page: 1, pageSize: 20 });
    const detail = await adapter.getById("CVE-2024-1001");

    expect(ok.cves.length).toBe(1);
    expect(ok.cves[0].cveId).toBe("CVE-2024-1001");
    expect(detail.cve?.cveId).toBe("CVE-2024-1001");
    expect(detail.cve?.affected.packages.length).toBeGreaterThan(0);
    expect(notFound.cves).toEqual([]);
  });

  it("KEV adapter loads catalog and lookup", async () => {
    const config = createTestConfig();

    server.use(http.get("https://kev.test/catalog.json", () => HttpResponse.json(kevFixture)));

    const adapter = new KevAdapter({ config });
    const catalog = await adapter.getCatalog();
    const byIds = await adapter.getByCveIds(["CVE-2024-1001", "CVE-2024-9999"]);
    const byId = await adapter.getById("CVE-2024-1001");

    expect(catalog.entries.length).toBeGreaterThan(0);
    expect(byIds.byId.has("CVE-2024-1001")).toBe(true);
    expect(byId.entry?.cveId).toBe("CVE-2024-1001");
  });

  it("EPSS adapter maps scores and lookup", async () => {
    const config = createTestConfig();

    server.use(http.get("https://epss.test/data", () => HttpResponse.json(epssFixture)));

    const adapter = new EpssAdapter({ config });
    const scores = await adapter.getScores(["CVE-2024-1001", "CVE-2024-1002"]);
    const score = await adapter.getById("CVE-2024-1001");

    expect(scores.byId.get("CVE-2024-1001")?.score).toBe(0.95);
    expect(score.entry?.cveId).toBe("CVE-2024-1001");
  });
});
