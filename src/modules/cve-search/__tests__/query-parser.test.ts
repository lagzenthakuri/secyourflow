import { describe, expect, it } from "vitest";
import { parseCveSearchQuery } from "../domain/query-parser";

describe("domain/query-parser", () => {
  it("classifies CVE IDs as exact id lookups", () => {
    const parsed = parseCveSearchQuery("cve-2018-6341", "auto");

    expect(parsed.kind).toBe("cveId");
    expect(parsed.includeTerms).toEqual(["CVE-2018-6341"]);
    expect(parsed.excludeTerms).toEqual([]);
  });

  it("routes explicit product prefixes to product mode", () => {
    const parsed = parseCveSearchQuery("vendor:facebook product:react", "text");

    expect(parsed.kind).toBe("product");
    expect(parsed.includeTerms).toContain("facebook");
    expect(parsed.includeTerms).toContain("react");
  });

  it("routes explicit text prefixes to text mode", () => {
    const parsed = parseCveSearchQuery("text:open redirect", "product");

    expect(parsed.kind).toBe("text");
    expect(parsed.includeTerms).toEqual(["open", "redirect"]);
  });

  it("uses auto mode defaults for single-token and multi-token queries", () => {
    expect(parseCveSearchQuery("React", "auto").kind).toBe("product");
    expect(parseCveSearchQuery("open redirect", "auto").kind).toBe("text");
  });

  it("applies product collision excludes for ambiguous React token", () => {
    const parsed = parseCveSearchQuery("React", "product");

    expect(parsed.kind).toBe("product");
    expect(parsed.excludeTerms).toEqual(expect.arrayContaining(["reactos", "reactor", "reactions"]));
  });

  it("does not apply collision excludes when excluded terms are explicit", () => {
    const parsed = parseCveSearchQuery("React ReactOS", "product");

    expect(parsed.excludeTerms).not.toContain("reactos");
    expect(parsed.excludeTerms).toContain("reactor");
  });

  it("does not apply collision excludes in text mode", () => {
    const parsed = parseCveSearchQuery("React", "text");

    expect(parsed.kind).toBe("text");
    expect(parsed.excludeTerms).toEqual([]);
  });

  it("keeps ReactOS query targeted to ReactOS tokens", () => {
    const parsed = parseCveSearchQuery("ReactOS", "auto");

    expect(parsed.kind).toBe("product");
    expect(parsed.includeTerms).toEqual(["reactos"]);
    expect(parsed.excludeTerms).toEqual([]);
  });
});
