import { describe, expect, it } from "vitest";
import { rankCves } from "../domain/ranking";
import { createSyntheticCve } from "./fixtures/synthetic-cves";

describe("domain/ranking", () => {
  it("prioritizes KEV then EPSS then CVSS then recency", () => {
    const kevHigh = createSyntheticCve({ cveId: "CVE-2024-1001", kev: true, epss: 0.9, cvss: 9.1 });
    const notKevHigherCvss = createSyntheticCve({
      cveId: "CVE-2024-1002",
      kev: false,
      epss: 0.95,
      cvss: 9.9,
    });

    const ranked = rankCves([notKevHigherCvss, kevHigh], "relevance");
    expect(ranked[0].cveId).toBe("CVE-2024-1001");
  });

  it("sorts by newest when requested", () => {
    const old = createSyntheticCve({ cveId: "CVE-2024-1001", modified: "2024-01-01T00:00:00.000Z" });
    const fresh = createSyntheticCve({ cveId: "CVE-2024-1002", modified: "2024-12-01T00:00:00.000Z" });

    const ranked = rankCves([old, fresh], "newest");
    expect(ranked[0].cveId).toBe("CVE-2024-1002");
  });

  it("sorts by cvss and epss", () => {
    const low = createSyntheticCve({ cveId: "CVE-2024-1001", cvss: 4.0, epss: 0.1 });
    const high = createSyntheticCve({ cveId: "CVE-2024-1002", cvss: 9.0, epss: 0.8 });

    expect(rankCves([low, high], "cvss")[0].cveId).toBe("CVE-2024-1002");
    expect(rankCves([low, high], "epss")[0].cveId).toBe("CVE-2024-1002");
  });

  it("boosts exact query matches for relevance sorting", () => {
    const exactDescriptionMatch = createSyntheticCve({
      cveId: "CVE-2024-9001",
      description: "react renderer bypass in package parser",
      kev: false,
      epss: 0.2,
      cvss: 4.8,
    });

    const nonMatchingButRiskier = createSyntheticCve({
      cveId: "CVE-2024-9002",
      description: "kernel memory corruption in io subsystem",
      kev: true,
      epss: 0.95,
      cvss: 9.8,
    });

    const ranked = rankCves([nonMatchingButRiskier, exactDescriptionMatch], "relevance", "react renderer");
    expect(ranked[0].cveId).toBe("CVE-2024-9001");
  });
});
