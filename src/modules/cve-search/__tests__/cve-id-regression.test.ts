import { describe, expect, it, vi } from "vitest";
import { CveSearchService } from "../api/service";
import { detailResponseSchema } from "../domain/schemas";
import { createTestConfig } from "./integration-helpers";

const REGRESSION_CVE_IDS = [
  "CVE-1999-0001",
  "CVE-1999-0046",
  "CVE-2000-0148",
  "CVE-2000-0336",
  "CVE-2001-0260",
  "CVE-2001-0500",
  "CVE-2002-0392",
  "CVE-2002-0866",
  "CVE-2003-0003",
  "CVE-2004-0116",
  "CVE-2005-1794",
  "CVE-2005-2558",
  "CVE-2006-0987",
  "CVE-2006-3747",
  "CVE-2007-0038",
  "CVE-2007-1741",
  "CVE-2008-0166",
  "CVE-2008-4250",
  "CVE-2009-2698",
  "CVE-2009-3555",
  "CVE-2010-0232",
  "CVE-2010-2568",
  "CVE-2011-0611",
  "CVE-2011-2461",
  "CVE-2012-0158",
  "CVE-2012-1823",
  "CVE-2012-4969",
  "CVE-2013-0156",
  "CVE-2013-0422",
  "CVE-2013-3893",
  "CVE-2014-0160",
  "CVE-2014-6271",
  "CVE-2014-3566",
  "CVE-2015-0235",
  "CVE-2015-1635",
  "CVE-2015-7547",
  "CVE-2016-0728",
  "CVE-2016-0800",
  "CVE-2016-5195",
  "CVE-2017-0144",
  "CVE-2017-5638",
  "CVE-2017-5753",
  "CVE-2017-5754",
  "CVE-2017-11882",
  "CVE-2018-4878",
  "CVE-2018-7600",
  "CVE-2018-8174",
  "CVE-2018-1000001",
  "CVE-2018-13379",
  "CVE-2019-0708",
  "CVE-2019-11510",
  "CVE-2019-19781",
  "CVE-2019-3396",
  "CVE-2020-0601",
  "CVE-2020-0796",
  "CVE-2020-1350",
  "CVE-2020-1472",
  "CVE-2020-16898",
  "CVE-2021-21972",
  "CVE-2021-26855",
  "CVE-2021-3156",
  "CVE-2021-34473",
  "CVE-2021-44228",
  "CVE-2022-0778",
  "CVE-2022-22965",
  "CVE-2022-26134",
  "CVE-2022-30190",
  "CVE-2022-40684",
  "CVE-2023-0669",
  "CVE-2023-23397",
  "CVE-2023-27350",
  "CVE-2023-34362",
  "CVE-2023-3519",
  "CVE-2024-21762",
  "CVE-2024-21887",
  "CVE-2024-24919",
  "CVE-2024-3094",
  "CVE-2024-3400",
  "CVE-2025-0204",
  "CVE-2025-0321",
  "CVE-2025-0412",
  "CVE-2025-0678",
  "CVE-2025-1023",
  "CVE-2018-9995",
  "CVE-2020-5902",
  "CVE-2021-22986",
  "CVE-2022-1388",
  "CVE-2023-22515",
  "CVE-2014-4114",
  "CVE-2003-0818",
  "CVE-2009-3103",
  "CVE-2016-4010",
  "CVE-2017-12635",
  "CVE-2019-10149",
  "CVE-2020-10189",
  "CVE-2021-45046",
  "CVE-2022-41040",
  "CVE-2023-36884",
  "CVE-2024-20353",
  "CVE-2025-1189",
] as const;

function jsonResponse(status: number, body: unknown): Response {
  return new Response(JSON.stringify(body), {
    status,
    headers: { "content-type": "application/json" },
  });
}

function toUrl(input: RequestInfo | URL): URL {
  if (typeof input === "string") {
    return new URL(input);
  }

  if (input instanceof URL) {
    return input;
  }

  return new URL(input.url);
}

function buildMockNvdPayload(cveId: string): unknown {
  return {
    vulnerabilities: [
      {
        cve: {
          id: cveId,
          published: "2024-01-01T00:00:00.000Z",
          lastModified: "2024-01-02T00:00:00.000Z",
          descriptions: [{ lang: "en", value: `Mocked description for ${cveId}` }],
          references: [{ url: `https://nvd.nist.gov/vuln/detail/${cveId}`, source: "NVD" }],
          metrics: {
            cvssMetricV31: [
              {
                cvssData: {
                  baseSeverity: "HIGH",
                  baseScore: 7.5,
                  vectorString: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
                  version: "3.1",
                },
              },
            ],
          },
          configurations: [],
        },
      },
    ],
  };
}

describe("cve id regression", () => {
  it(
    "returns the exact requested CVE for the full regression list using mocked upstream data",
    async () => {
      const config = createTestConfig({
        nvdApiBaseUrl: "https://nvd.test/rest/json/cves/2.0",
        mitreApiBaseUrl: "https://mitre.test/api/cve",
        cisaKevUrl: "https://kev.test/catalog.json",
        epssApiBaseUrl: "https://epss.test/data",
      });

      const fetchImpl = vi.fn<typeof fetch>(async (input) => {
        const url = toUrl(input);

        if (url.origin === "https://nvd.test") {
          const requestedCveId = url.searchParams.get("cveId");
          if (!requestedCveId) {
            return jsonResponse(200, { vulnerabilities: [] });
          }

          return jsonResponse(200, buildMockNvdPayload(requestedCveId.toUpperCase()));
        }

        if (url.origin === "https://mitre.test") {
          const segments = url.pathname.split("/").filter(Boolean);
          const cveId = segments[segments.length - 1] ?? "";

          return jsonResponse(200, {
            cveMetadata: {
              cveId: cveId.toUpperCase(),
              state: "PUBLISHED",
              datePublished: "2024-01-01T00:00:00.000Z",
              dateUpdated: "2024-01-02T00:00:00.000Z",
            },
            containers: {
              cna: {
                title: `MITRE title for ${cveId.toUpperCase()}`,
                descriptions: [{ lang: "en", value: `MITRE description for ${cveId.toUpperCase()}` }],
                references: [{ url: `https://www.cve.org/CVERecord?id=${cveId.toUpperCase()}` }],
              },
            },
          });
        }

        if (url.origin === "https://kev.test") {
          return jsonResponse(200, {
            vulnerabilities: [
              {
                cveID: REGRESSION_CVE_IDS[0],
                dateAdded: "2024-01-01",
                dueDate: "2024-02-01",
                notes: "mocked kev entry",
              },
            ],
          });
        }

        if (url.origin === "https://epss.test") {
          const ids = (url.searchParams.get("cve") ?? "")
            .split(",")
            .map((value) => value.trim())
            .filter(Boolean);

          return jsonResponse(200, {
            data: ids.map((id) => ({
              cve: id,
              epss: "0.42",
              percentile: "0.84",
              date: "2024-11-11",
            })),
          });
        }

        return jsonResponse(404, { error: "unknown endpoint" });
      });

      const service = new CveSearchService(config, fetchImpl);

      for (const cveId of REGRESSION_CVE_IDS) {
        const detail = await service.getById(cveId);
        expect(detail).not.toBeNull();
        expect(detail?.data.cveId).toBe(cveId);
        expect(detail?.data.description).toContain(cveId);
        expect(detail?.data.description.length).toBeGreaterThan(10);

        const parsed = detailResponseSchema.safeParse(detail);
        expect(parsed.success).toBe(true);
      }
    },
    30_000,
  );

  it(
    "search returns the exact CVE when searching by CVE ID",
    async () => {
      const config = createTestConfig({
        nvdApiBaseUrl: "https://nvd.test/rest/json/cves/2.0",
        mitreApiBaseUrl: "https://mitre.test/api/cve",
        cisaKevUrl: "https://kev.test/catalog.json",
        epssApiBaseUrl: "https://epss.test/data",
      });

      const fetchImpl = vi.fn<typeof fetch>(async (input) => {
        const url = toUrl(input);

        if (url.origin === "https://nvd.test") {
          const requestedCveId = url.searchParams.get("cveId");
          if (!requestedCveId) {
            return jsonResponse(200, { vulnerabilities: [] });
          }

          return jsonResponse(200, buildMockNvdPayload(requestedCveId.toUpperCase()));
        }

        if (url.origin === "https://mitre.test") {
          const segments = url.pathname.split("/").filter(Boolean);
          const cveId = segments[segments.length - 1] ?? "";

          return jsonResponse(200, {
            cveMetadata: {
              cveId: cveId.toUpperCase(),
              state: "PUBLISHED",
              datePublished: "2024-01-01T00:00:00.000Z",
              dateUpdated: "2024-01-02T00:00:00.000Z",
            },
            containers: {
              cna: {
                title: `MITRE title for ${cveId.toUpperCase()}`,
                descriptions: [{ lang: "en", value: `MITRE description for ${cveId.toUpperCase()}` }],
                references: [{ url: `https://www.cve.org/CVERecord?id=${cveId.toUpperCase()}` }],
              },
            },
          });
        }

        if (url.origin === "https://kev.test") {
          return jsonResponse(200, { vulnerabilities: [] });
        }

        if (url.origin === "https://epss.test") {
          return jsonResponse(200, { data: [] });
        }

        return jsonResponse(404, { error: "unknown endpoint" });
      });

      const service = new CveSearchService(config, fetchImpl);
      const testIds = [
        "CVE-2014-0160",
        "CVE-2017-0144",
        "CVE-2021-44228",
        "CVE-2024-3094",
      ];

      for (const cveId of testIds) {
        const result = await service.search({
          q: cveId,
          page: 1,
          pageSize: 20,
          sort: "relevance",
        });

        expect(result.data.length).toBeGreaterThan(0);
        expect(result.data[0].cveId).toBe(cveId);
        expect(result.data[0].description).toContain(cveId);
      }
    },
    15_000,
  );
});
