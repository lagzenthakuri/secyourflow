import { describe, expect, it } from "vitest";
import { applySearchFilters, paginate } from "../domain/filtering";
import { createSyntheticCve, syntheticCves } from "./fixtures/synthetic-cves";

describe("domain/filtering", () => {
  it("filters by query text and severity", () => {
    const cves = [
      createSyntheticCve({ cveId: "CVE-2024-1001", description: "openssl overflow", severity: "CRITICAL" }),
      createSyntheticCve({ cveId: "CVE-2024-1002", description: "other", severity: "LOW" }),
    ];

    const filtered = applySearchFilters(cves, {
      q: "openssl",
      page: 1,
      pageSize: 20,
      sort: "relevance",
      severity: "CRITICAL",
    });

    expect(filtered).toHaveLength(1);
    expect(filtered[0].cveId).toBe("CVE-2024-1001");
  });

  it("filters by KEV and score ranges", () => {
    const filtered = applySearchFilters(syntheticCves, {
      q: "",
      page: 1,
      pageSize: 20,
      sort: "relevance",
      kev: "KEV_ONLY",
      epssMin: 0.8,
      cvssMin: 9,
    });

    expect(filtered.length).toBeGreaterThan(0);
    expect(filtered.every((entry) => entry.kev.isKnownExploited)).toBe(true);
  });

  it("paginates deterministically", () => {
    const page = paginate([1, 2, 3, 4, 5], 2, 2);
    expect(page).toEqual([3, 4]);
  });
});
