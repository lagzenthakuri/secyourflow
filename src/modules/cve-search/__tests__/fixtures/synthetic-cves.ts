import type { NormalizedCve } from "../../domain/types";

interface CreateSyntheticOptions {
  cveId: string;
  title?: string | null;
  description?: string;
  severity?: NormalizedCve["severity"];
  cvss?: number | null;
  epss?: number | null;
  percentile?: number | null;
  kev?: boolean;
  modified?: string | null;
  published?: string | null;
}

export function createSyntheticCve(options: CreateSyntheticOptions): NormalizedCve {
  return {
    cveId: options.cveId,
    title: options.title ?? options.cveId,
    description: options.description ?? `Synthetic vulnerability for ${options.cveId}`,
    published: options.published ?? "2024-01-10T00:00:00.000Z",
    lastModified: options.modified ?? "2024-06-10T00:00:00.000Z",
    severity: options.severity ?? "MEDIUM",
    cvss: {
      version: "3.1",
      baseScore: options.cvss === undefined ? 6.3 : options.cvss,
      vector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
    },
    epss: {
      score: options.epss === undefined ? 0.12 : options.epss,
      percentile: options.percentile === undefined ? 0.44 : options.percentile,
      asOf: "2024-09-01T00:00:00.000Z",
    },
    kev: {
      isKnownExploited: options.kev ?? false,
      dateAdded: options.kev ? "2024-07-01T00:00:00.000Z" : null,
      dueDate: options.kev ? "2024-08-01T00:00:00.000Z" : null,
      notes: options.kev ? "Known exploited in wild" : null,
    },
    affected: {
      cpe: [`cpe:2.3:a:vendor:product:${options.cveId.toLowerCase()}:*:*:*:*:*:*:*`],
      packages: [
        {
          ecosystem: "npm",
          name: `pkg-${options.cveId.toLowerCase()}`,
          ranges: [">=1.0.0 <2.0.0"],
        },
      ],
    },
    references: [
      {
        url: `https://example.com/${options.cveId}`,
        source: "synthetic",
      },
    ],
    sourceAttribution: [
      {
        source: "NVD",
        url: `https://nvd.nist.gov/vuln/detail/${options.cveId}`,
      },
    ],
  };
}

export const syntheticCves: NormalizedCve[] = [
  createSyntheticCve({
    cveId: "CVE-2024-1001",
    severity: "CRITICAL",
    cvss: 9.8,
    epss: 0.95,
    percentile: 0.99,
    kev: true,
    modified: "2024-11-10T12:00:00.000Z",
  }),
  createSyntheticCve({
    cveId: "CVE-2024-1002",
    severity: "HIGH",
    cvss: 8.3,
    epss: 0.8,
    percentile: 0.93,
    kev: false,
    modified: "2024-10-10T12:00:00.000Z",
  }),
  createSyntheticCve({
    cveId: "CVE-2024-1003",
    severity: "HIGH",
    cvss: null,
    epss: 0.1,
    percentile: 0.2,
    kev: false,
    modified: "2024-09-02T12:00:00.000Z",
  }),
  createSyntheticCve({
    cveId: "CVE-2024-1004",
    severity: "MEDIUM",
    cvss: 6.2,
    epss: null,
    percentile: null,
    kev: false,
    modified: "2024-08-03T12:00:00.000Z",
  }),
  createSyntheticCve({
    cveId: "CVE-2024-1005",
    severity: "LOW",
    cvss: 3.2,
    epss: 0.02,
    percentile: 0.01,
    kev: false,
    modified: "2024-07-04T12:00:00.000Z",
  }),
  createSyntheticCve({
    cveId: "CVE-2024-1006",
    severity: "UNKNOWN",
    cvss: null,
    epss: null,
    percentile: null,
    kev: false,
    modified: "2024-06-05T12:00:00.000Z",
  }),
  createSyntheticCve({
    cveId: "CVE-2023-2001",
    severity: "CRITICAL",
    cvss: 10,
    epss: 0.88,
    percentile: 0.97,
    kev: true,
    modified: "2023-12-08T12:00:00.000Z",
  }),
  createSyntheticCve({
    cveId: "CVE-2023-2002",
    severity: "MEDIUM",
    cvss: 5.4,
    epss: 0.32,
    percentile: 0.51,
    kev: false,
    modified: "2023-11-08T12:00:00.000Z",
  }),
  createSyntheticCve({
    cveId: "CVE-2022-3001",
    severity: "HIGH",
    cvss: 7.2,
    epss: 0.56,
    percentile: 0.71,
    kev: false,
    modified: "2022-10-08T12:00:00.000Z",
  }),
  createSyntheticCve({
    cveId: "CVE-2022-3002",
    severity: "LOW",
    cvss: 2.5,
    epss: 0.08,
    percentile: 0.09,
    kev: false,
    modified: "2022-08-01T12:00:00.000Z",
  }),
  createSyntheticCve({
    cveId: "CVE-2021-4001",
    severity: "MEDIUM",
    cvss: 4.8,
    epss: 0.16,
    percentile: 0.26,
    kev: false,
    modified: "2021-05-01T12:00:00.000Z",
  }),
  createSyntheticCve({
    cveId: "CVE-2020-5001",
    severity: "HIGH",
    cvss: 8.1,
    epss: 0.74,
    percentile: 0.9,
    kev: true,
    modified: "2020-03-01T12:00:00.000Z",
  }),
];

export const nvdSearchFixture = {
  vulnerabilities: [
    {
      cve: {
        id: "CVE-2024-1001",
        published: "2024-01-01T08:00:00.000",
        lastModified: "2024/11/10",
        descriptions: [{ lang: "en", value: "Critical remote code execution in auth module" }],
        references: [{ url: "https://nvd.nist.gov/vuln/detail/CVE-2024-1001", source: "NVD" }],
        metrics: {
          cvssMetricV31: [
            {
              cvssData: {
                baseSeverity: "CRITICAL",
                baseScore: 9.8,
                vectorString: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
                version: "3.1",
              },
            },
          ],
        },
        configurations: [
          {
            nodes: [
              {
                cpeMatch: [
                  {
                    vulnerable: true,
                    criteria: "cpe:2.3:a:example:auth-service:1.2.0:*:*:*:*:*:*:*",
                  },
                ],
              },
            ],
          },
        ],
      },
    },
    {
      cve: {
        id: "CVE-2024-1002",
        published: "20240103",
        lastModified: "2024-10-10T08:00:00.000Z",
        descriptions: [{ lang: "en", value: "High severity vuln in package parser" }],
        references: [{ url: "https://example.com/advisory/1002", source: "vendor" }],
        metrics: {
          cvssMetricV31: [
            {
              cvssData: {
                baseSeverity: "HIGH",
                baseScore: 8.3,
                vectorString: "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H",
                version: "3.1",
              },
            },
          ],
        },
        configurations: [
          {
            nodes: [
              {
                cpeMatch: [
                  {
                    vulnerable: true,
                    criteria: "cpe:2.3:a:example:parser:3.4.5:*:*:*:*:*:*:*",
                  },
                ],
              },
            ],
          },
        ],
      },
    },
  ],
};

export const mitreFixtureById: Record<string, unknown> = {
  "CVE-2024-1001": {
    cveMetadata: {
      cveId: "CVE-2024-1001",
      state: "PUBLISHED",
      datePublished: "2024-01-02T00:00:00.000Z",
      dateUpdated: "2024-11-12T00:00:00.000Z",
    },
    containers: {
      cna: {
        title: "Auth service RCE",
        descriptions: [{ lang: "en", value: "MITRE record for auth service RCE." }],
        references: [{ url: "https://www.cve.org/CVERecord?id=CVE-2024-1001" }],
        metrics: [
          {
            cvssV3_1: {
              version: "3.1",
              baseScore: 9.8,
              baseSeverity: "CRITICAL",
              vectorString: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
            },
          },
        ],
        affected: [
          {
            vendor: "example",
            product: "auth-service",
            cpes: ["cpe:2.3:a:example:auth-service:1.2.0:*:*:*:*:*:*:*"],
            versions: [{ status: "affected", version: ">=1.0.0", lessThan: "1.0.5" }],
          },
        ],
      },
    },
  },
  "CVE-2024-1003": {
    cveMetadata: {
      cveId: "CVE-2024-1003",
      state: "PUBLISHED",
      datePublished: "2024-02-02T00:00:00.000Z",
      dateUpdated: "2024-09-03T00:00:00.000Z",
    },
    containers: {
      cna: {
        title: "Deserializer bug",
        descriptions: [{ lang: "en", value: "MITRE record missing CVSS values." }],
        references: [{ url: "https://www.cve.org/CVERecord?id=CVE-2024-1003" }],
        affected: [
          {
            vendor: "example",
            product: "deserialize-me",
            versions: [{ status: "affected", version: ">=2.0.0", lessThan: "2.1.0" }],
          },
        ],
      },
    },
  },
};

export const kevFixture = {
  vulnerabilities: [
    {
      cveID: "CVE-2024-1001",
      dateAdded: "2024-07-01",
      dueDate: "2024-08-01",
      notes: "Actively exploited by multiple groups",
      shortDescription: "RCE in auth module",
    },
    {
      cveID: "CVE-2020-5001",
      dateAdded: "2020-03-15",
      dueDate: "2020-04-01",
      notes: "Legacy device exploitation",
      shortDescription: "Legacy exploit",
    },
  ],
};

export const epssFixture = {
  data: [
    {
      cve: "CVE-2024-1001",
      epss: "0.95",
      percentile: "0.99",
      date: "2024-11-10",
    },
    {
      cve: "CVE-2024-1002",
      epss: "0.82",
      percentile: "0.94",
      date: "2024-11-10",
    },
    {
      cve: "CVE-2024-1003",
      epss: "0.12",
      percentile: "0.22",
      date: "2024-11-10",
    },
  ],
};
