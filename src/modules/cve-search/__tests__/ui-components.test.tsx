// @vitest-environment jsdom

import React from "react";
import { act, fireEvent, render, screen } from "@testing-library/react";
import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
import { CveDetailPageClient } from "../ui/CveDetailPageClient";
import { CveSearchPageClient } from "../ui/CveSearchPageClient";
import { createSyntheticCve } from "./fixtures/synthetic-cves";

const push = vi.fn();
const replace = vi.fn();
let params = new URLSearchParams("q=CVE-2024-1001&page=1&pageSize=20&sort=relevance");

vi.mock("next/navigation", () => ({
  useSearchParams: () => params,
  useRouter: () => ({ push, replace }),
  usePathname: () => "/cves",
}));

vi.mock("@/components/layout/DashboardLayout", () => ({
  DashboardLayout: ({ children }: { children: React.ReactNode }) => <div data-testid="layout">{children}</div>,
}));

interface MockLinkProps extends React.AnchorHTMLAttributes<HTMLAnchorElement> {
  children: React.ReactNode;
  href?: string;
}

vi.mock("next/link", () => ({
  default: ({ children, href, ...props }: MockLinkProps) => (
    <a href={typeof href === "string" ? href : "#"} {...props}>
      {children}
    </a>
  ),
}));

describe("ui components", () => {
  beforeEach(() => {
    params = new URLSearchParams("q=CVE-2024-1001&page=1&pageSize=20&sort=relevance");
    push.mockReset();
    replace.mockReset();
  });

  afterEach(() => {
    vi.useRealTimers();
    vi.restoreAllMocks();
  });

  it("renders search page results and partial warning", async () => {
    const cve = createSyntheticCve({ cveId: "CVE-2024-1001", kev: true });

    vi.spyOn(global, "fetch").mockResolvedValue(
      new Response(
        JSON.stringify({
          meta: {
            query: "CVE-2024-1001",
            page: 1,
            pageSize: 20,
            tookMs: 33,
            sourcesUsed: ["NVD"],
            partial: true,
            warnings: ["nvd timeout"],
          },
          data: [cve],
        }),
        { status: 200 },
      ),
    );

    render(<CveSearchPageClient />);

    const cveEntries = await screen.findAllByText("CVE-2024-1001");
    expect(cveEntries.length).toBeGreaterThan(0);
    expect(screen.getByText(/nvd timeout/i)).toBeTruthy();
  });

  it("debounces search input and updates url", async () => {
    vi.useFakeTimers();

    const fetchSpy = vi.spyOn(global, "fetch").mockResolvedValue(
      new Response(
        JSON.stringify({
          meta: {
            query: "",
            page: 1,
            pageSize: 20,
            tookMs: 10,
            sourcesUsed: ["NVD"],
            partial: false,
            warnings: [],
          },
          data: [],
        }),
        { status: 200 },
      ),
    );

    render(<CveSearchPageClient />);

    await act(async () => {
      await Promise.resolve();
    });

    const input = screen.getByPlaceholderText(/Search CVEs, products, vendors, keywords/i);
    fireEvent.change(input, { target: { value: "openssl" } });

    await act(async () => {
      await vi.advanceTimersByTimeAsync(400);
    });

    expect(replace).toHaveBeenCalled();

    const requestedUrls = fetchSpy.mock.calls
      .map(([input]) => (typeof input === "string" ? input : input.toString()))
      .filter((url) => url.includes("/api/cves/search?"));

    expect(requestedUrls.some((url) => url.includes("q=openssl"))).toBe(true);
    expect(requestedUrls.some((url) => url.includes("mode=auto"))).toBe(true);
  });

  it("renders detail page", async () => {
    const cve = createSyntheticCve({
      cveId: "CVE-2024-1001",
      title: "Auth bypass",
      kev: true,
    });

    vi.spyOn(global, "fetch").mockResolvedValue(
      new Response(
        JSON.stringify({
          meta: {
            cveId: "CVE-2024-1001",
            tookMs: 20,
            sourcesUsed: ["NVD"],
            partial: false,
            warnings: [],
          },
          data: cve,
        }),
        { status: 200 },
      ),
    );

    render(<CveDetailPageClient cveId="CVE-2024-1001" />);

    expect(await screen.findByText("CVE-2024-1001")).toBeTruthy();
    expect(screen.getByText(/Known Exploited/i)).toBeTruthy();
    expect(screen.getByText(/Auth bypass/i)).toBeTruthy();
  });

  it("renders detail error state on 404", async () => {
    vi.spyOn(global, "fetch").mockResolvedValue(
      new Response(JSON.stringify({ error: "missing" }), {
        status: 404,
      }),
    );

    render(<CveDetailPageClient cveId="CVE-2024-9999" />);

    expect(await screen.findByText(/was not found/i)).toBeTruthy();
  });
});
