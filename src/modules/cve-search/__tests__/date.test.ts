import { describe, expect, it, vi } from "vitest";
import { nowMs, parseDateToIso, toDateOrEpoch } from "../domain/date";

describe("domain/date", () => {
  it("parses multiple date formats into ISO", () => {
    expect(parseDateToIso("2024-11-10T12:00:00Z")).toBe("2024-11-10T12:00:00.000Z");
    expect(parseDateToIso("2024/11/10")).toBe("2024-11-10T00:00:00.000Z");
    expect(parseDateToIso("20241110")).toBe("2024-11-10T00:00:00.000Z");
  });

  it("returns null for invalid dates", () => {
    expect(parseDateToIso("")).toBeNull();
    expect(parseDateToIso("not-a-date")).toBeNull();
    expect(parseDateToIso(null)).toBeNull();
  });

  it("converts ISO to timestamp with fallback", () => {
    expect(toDateOrEpoch("2024-11-10T00:00:00.000Z")).toBe(1731196800000);
    expect(toDateOrEpoch("invalid")).toBe(0);
    expect(toDateOrEpoch(null)).toBe(0);
  });

  it("returns current time in ms", () => {
    vi.useFakeTimers();
    vi.setSystemTime(new Date("2026-02-07T12:00:00.000Z"));

    expect(nowMs()).toBe(new Date("2026-02-07T12:00:00.000Z").getTime());

    vi.useRealTimers();
  });
});
