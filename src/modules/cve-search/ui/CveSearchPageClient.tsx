"use client";

import Link from "next/link";
import { useEffect, useMemo, useState } from "react";
import { usePathname, useRouter, useSearchParams } from "next/navigation";
import { AlertTriangle, ChevronDown, Database, Search, ShieldCheck } from "lucide-react";
import { DashboardLayout } from "@/components/layout/DashboardLayout";
import { useDebouncedValue } from "./useDebouncedValue";
import { formatDate, formatScore, severityBadgeClass } from "./presenters";
import type { SearchApiResponse } from "./types";

const SEVERITY_OPTIONS = [
  { value: "ALL", label: "All Severities" },
  { value: "CRITICAL", label: "Critical" },
  { value: "HIGH", label: "High" },
  { value: "MEDIUM", label: "Medium" },
  { value: "LOW", label: "Low" },
  { value: "UNKNOWN", label: "Unknown" },
];

const YEAR_OPTIONS = [
  { value: "ALL", label: "All Years" },
  { value: "2026", label: "2026" },
  { value: "2025", label: "2025" },
  { value: "2024", label: "2024" },
  { value: "2023", label: "2023" },
  { value: "2022", label: "2022" },
  { value: "2021", label: "2021" },
  { value: "2020", label: "2020" },
  { value: "2019", label: "2019" },
  { value: "2018", label: "2018" },
  { value: "2017", label: "2017" },
  { value: "2016", label: "2016" },
  { value: "2015", label: "2015" },
  { value: "2010s", label: "2010s" },
  { value: "2000s", label: "2000s" },
  { value: "1999-2009", label: "1999-2009" },
];

const SORT_OPTIONS = [
  { value: "RELEVANCE", label: "Relevance" },
  { value: "PUBLISHED_DESC", label: "Newest" },
  { value: "MODIFIED_DESC", label: "Recently Updated" },
  { value: "CVSS_DESC", label: "Highest CVSS" },
];

const PAGE_SIZE_OPTIONS = [
  { value: "10", label: "10 / page" },
  { value: "20", label: "20 / page" },
  { value: "50", label: "50 / page" },
];

const MODE_OPTIONS = [
  { value: "auto", label: "Auto" },
  { value: "product", label: "Product" },
  { value: "text", label: "Full Text" },
];

function toPositiveInt(value: string | null, fallback: number): number {
  if (!value) return fallback;
  const parsed = Number(value);
  if (!Number.isInteger(parsed) || parsed <= 0) {
    return fallback;
  }
  return parsed;
}

export function CveSearchPageClient() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const pathname = usePathname();

  const q = searchParams.get("q") ?? "";
  const severity = searchParams.get("severity") ?? "ALL";
  const year = searchParams.get("year") ?? "ALL";
  const kev = searchParams.get("kev") ?? "ANY";
  const sort = searchParams.get("sort") ?? "RELEVANCE";
  const rawMode = (searchParams.get("mode") ?? "auto").toLowerCase();
  const mode = rawMode === "product" || rawMode === "text" ? rawMode : "auto";
  const page = toPositiveInt(searchParams.get("page"), 1);
  const pageSize = Math.min(toPositiveInt(searchParams.get("pageSize"), 20), 50);

  const [input, setInput] = useState(q);
  const [result, setResult] = useState<SearchApiResponse | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const debouncedInput = useDebouncedValue(input, 300);

  useEffect(() => {
    setInput(q);
  }, [q]);

  const requestQuery = useMemo(() => {
    const params = new URLSearchParams();
    const debouncedQuery = debouncedInput.trim();
    if (debouncedQuery.length > 0) {
      params.set("q", debouncedQuery);
    }
    if (mode !== "auto") {
      params.set("mode", mode);
    }
    if (severity !== "ALL") params.set("severity", severity);
    if (year !== "ALL") params.set("year", year);
    if (kev !== "ANY") params.set("kev", kev);
    params.set("sort", sort);
    params.set("page", String(page));
    params.set("pageSize", String(pageSize));
    return params;
  }, [debouncedInput, mode, severity, year, kev, sort, page, pageSize]);

  useEffect(() => {
    if (debouncedInput === q) return;
    const next = new URLSearchParams(searchParams.toString());

    if (debouncedInput.trim().length > 0) {
      next.set("q", debouncedInput.trim());
    } else {
      next.delete("q");
    }

    next.set("page", "1");
    router.replace(`${pathname}?${next.toString()}`, { scroll: false });
  }, [debouncedInput, q, router, pathname, searchParams]);

  useEffect(() => {
    const controller = new AbortController();

    async function run(): Promise<void> {
      setIsLoading(true);
      setError(null);

      try {
        const response = await fetch(`/api/cves/search?${requestQuery.toString()}`, {
          method: "POST",
          signal: controller.signal,
          cache: "no-store",
          headers: {
            Accept: "application/json",
          },
        });

        if (!response.ok) {
          throw new Error(`Search request failed with status ${response.status}`);
        }

        const payload = (await response.json()) as SearchApiResponse;
        setResult(payload);
      } catch (fetchError) {
        if (controller.signal.aborted) return;
        setError(fetchError instanceof Error ? fetchError.message : "Failed to search CVEs");
      } finally {
        if (!controller.signal.aborted) {
          setIsLoading(false);
        }
      }
    }

    run().catch(() => {
      setError("Failed to search CVEs");
      setIsLoading(false);
    });

    return () => controller.abort();
  }, [requestQuery]);

  function updateQuery(updates: Record<string, string>): void {
    const next = new URLSearchParams(searchParams.toString());

    for (const [key, value] of Object.entries(updates)) {
      if (value === "ALL" || value === "ANY" || value === "auto" || value === "") {
        next.delete(key);
      } else {
        next.set(key, value);
      }
    }

    router.push(`${pathname}?${next.toString()}`, { scroll: false });
  }

  const canGoPrev = page > 1;
  const canGoNext = (result?.data.length ?? 0) >= pageSize;

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div>
          <div className="flex items-center gap-3 mb-2">
            <Database size={32} className="text-blue-400" />
            <h1 className="text-3xl font-bold text-white">CVE Database</h1>
          </div>
          <p className="text-[var(--text-secondary)]">
            Search and explore vulnerabilities from the NVD database
          </p>
        </div>

        {/* Large Search Bar */}
        <div className="relative">
          <Search className="absolute left-5 top-1/2 -translate-y-1/2 text-[var(--text-muted)]" size={20} />
          <input
            type="text"
            placeholder="Search CVEs, products, vendors, keywords (e.g., React, OpenSSL, CVE-2024-xxxx)"
            className="w-full bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-xl pl-14 pr-6 py-4 text-white text-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all"
            value={input}
            onChange={(e) => setInput(e.target.value)}
          />
        </div>

        {/* Primary Filters Row */}
        <div className="flex flex-wrap items-center gap-3 lg:gap-4">
          {/* Search Mode */}
          <div className="flex flex-col gap-1.5">
            <label className="text-xs text-[var(--text-muted)] font-medium">Mode</label>
            <select
              value={mode}
              onChange={(e) => updateQuery({ mode: e.target.value, page: "1" })}
              className="bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 min-w-[130px]"
            >
              {MODE_OPTIONS.map((option) => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          {/* Severity */}
          <div className="flex flex-col gap-1.5">
            <label className="text-xs text-[var(--text-muted)] font-medium">Severity</label>
            <select
              value={severity}
              onChange={(e) => updateQuery({ severity: e.target.value, page: "1" })}
              className="bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 min-w-[140px]"
            >
              {SEVERITY_OPTIONS.map((option) => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          {/* Year */}
          <div className="flex flex-col gap-1.5">
            <label className="text-xs text-[var(--text-muted)] font-medium">Year</label>
            <select
              value={year}
              onChange={(e) => updateQuery({ year: e.target.value, page: "1" })}
              className="bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 min-w-[120px]"
            >
              {YEAR_OPTIONS.map((option) => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          {/* Known Exploited */}
          <div className="flex flex-col gap-1.5">
            <label className="text-xs text-[var(--text-muted)] font-medium flex items-center gap-1">
              <span className="text-orange-400"></span>
              Known Exploited
            </label>
            <label className="flex items-center gap-2 bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg px-3 py-2 cursor-pointer hover:bg-[var(--bg-tertiary)]/80 transition-colors min-w-[120px]">
              <input
                type="checkbox"
                checked={kev === "KEV_ONLY"}
                onChange={(e) => updateQuery({ kev: e.target.checked ? "KEV_ONLY" : "ANY", page: "1" })}
                className="w-4 h-4 rounded bg-[var(--bg-secondary)] border-[var(--border-color)] text-orange-500 focus:ring-2 focus:ring-orange-500/50"
              />
              <span className="text-sm text-white">KEV Only</span>
            </label>
          </div>

          {/* Sort By */}
          <div className="flex flex-col gap-1.5">
            <label className="text-xs text-[var(--text-muted)] font-medium">Sort By</label>
            <select
              value={sort}
              onChange={(e) => updateQuery({ sort: e.target.value, page: "1" })}
              className="bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 min-w-[160px]"
            >
              {SORT_OPTIONS.map((option) => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          {/* Page Size */}
          <div className="flex flex-col gap-1.5">
            <label className="text-xs text-[var(--text-muted)] font-medium">Page Size</label>
            <select
              value={String(pageSize)}
              onChange={(e) => updateQuery({ pageSize: e.target.value, page: "1" })}
              className="bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 min-w-[110px]"
            >
              {PAGE_SIZE_OPTIONS.map((option) => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          {/* Advanced Button - Placeholder */}
          <div className="flex flex-col gap-1.5 ml-auto">
            <label className="text-xs text-transparent font-medium select-none">.</label>
            <button
              className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all border bg-[var(--bg-tertiary)] text-white border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]/80"
              disabled
              title="Advanced filters coming soon"
            >
              Advanced
              <ChevronDown size={14} />
            </button>
          </div>
        </div>

        {/* Results Count */}
        <div className="text-[var(--text-secondary)] text-sm">
          {result ? `Showing ${result.data.length} results on this page` : "Showing 0 results"}
        </div>

        {result?.meta.partial && result.meta.warnings.length > 0 ? (
          <div className="rounded-lg border border-amber-500/40 bg-amber-500/10 p-3 text-amber-200 text-sm flex gap-2">
            <AlertTriangle size={16} className="mt-0.5" />
            <div>{result.meta.warnings.join(" | ")}</div>
          </div>
        ) : null}

        {error ? (
          <div className="rounded-lg border border-red-500/40 bg-red-500/10 p-4 text-red-200">{error}</div>
        ) : null}

        <div className="card p-0 overflow-hidden">
          {isLoading ? (
            <div className="p-12 text-center text-[var(--text-secondary)]">Loading CVEs...</div>
          ) : result && result.data.length > 0 ? (
            <div className="divide-y divide-[var(--border-color)]">
              {result.data.map((cve) => (
                <Link
                  key={cve.cveId}
                  href={`/cves/${cve.cveId}`}
                  className="block p-4 hover:bg-[var(--bg-elevated)] transition-colors"
                >
                  <div className="flex flex-wrap items-center gap-3 mb-2">
                    <span className="text-blue-300 font-semibold">{cve.cveId}</span>
                    <span className={severityBadgeClass(cve.severity)}>{cve.severity}</span>
                    {cve.kev.isKnownExploited ? (
                      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded bg-orange-500/20 text-orange-300 text-xs border border-orange-500/30">
                        <ShieldCheck size={12} /> KEV
                      </span>
                    ) : null}
                  </div>

                  <h3 className="text-white font-medium mb-1">{cve.title || cve.cveId}</h3>
                  <p className="text-[var(--text-secondary)] text-sm line-clamp-2">{cve.description}</p>

                  <div className="mt-3 flex flex-wrap gap-3 text-xs text-[var(--text-muted)]">
                    <span>CVSS: {formatScore(cve.cvss.baseScore, 1)}</span>
                    <span>Updated: {formatDate(cve.lastModified)}</span>
                  </div>
                </Link>
              ))}
            </div>
          ) : (
            <div className="p-12 text-center text-[var(--text-secondary)]">
              No CVEs found for this query.
            </div>
          )}
        </div>

        <div className="flex items-center justify-between">
          <button
            className="btn btn-secondary disabled:opacity-40"
            disabled={!canGoPrev}
            onClick={() => updateQuery({ page: String(page - 1) })}
          >
            Previous
          </button>

          <div className="text-sm text-[var(--text-secondary)]">
            Page {page}
          </div>

          <button
            className="btn btn-secondary disabled:opacity-40"
            disabled={!canGoNext}
            onClick={() => updateQuery({ page: String(page + 1) })}
          >
            Next
          </button>
        </div>
      </div>
    </DashboardLayout>
  );
}
