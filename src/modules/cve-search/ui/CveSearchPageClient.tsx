"use client";

import Link from "next/link";
import { useEffect, useMemo, useState } from "react";
import { usePathname, useRouter, useSearchParams } from "next/navigation";
import {
  AlertTriangle,
  ChevronDown,
  ChevronRight,
  Database,
  RefreshCw,
  Search,
  ShieldCheck,
  Target,
} from "lucide-react";
import { DashboardLayout } from "@/components/layout/DashboardLayout";
import { PageHeader } from "@/components/ui/PageHeader";
import { ShieldLoader } from "@/components/ui/ShieldLoader";
import { cn } from "@/lib/utils";
import { useDebouncedValue } from "./useDebouncedValue";
import { formatDate, formatScore, severityBadgeClass } from "./presenters";
import type { SearchApiResponse } from "./types";

const SEVERITY_OPTIONS = [
  { value: "ALL", label: "All Severities" },
  { value: "CRITICAL", label: "Critical" },
  { value: "HIGH", label: "High" },
  { value: "MEDIUM", label: "Medium" },
  { value: "LOW", label: "Low" },
  { value: "UNKNOWN", label: "Unknown" },
];

const YEAR_OPTIONS = [
  { value: "ALL", label: "All Years" },
  { value: "2026", label: "2026" },
  { value: "2025", label: "2025" },
  { value: "2024", label: "2024" },
  { value: "2023", label: "2023" },
  { value: "2022", label: "2022" },
  { value: "2021", label: "2021" },
  { value: "2020", label: "2020" },
  { value: "2019", label: "2019" },
  { value: "2018", label: "2018" },
  { value: "2017", label: "2017" },
  { value: "2016", label: "2016" },
  { value: "2015", label: "2015" },
  { value: "2010s", label: "2010s" },
  { value: "2000s", label: "2000s" },
  { value: "1999-2009", label: "1999-2009" },
];

const SORT_OPTIONS = [
  { value: "RELEVANCE", label: "Relevance" },
  { value: "PUBLISHED_DESC", label: "Newest" },
  { value: "MODIFIED_DESC", label: "Recently Updated" },
  { value: "CVSS_DESC", label: "Highest CVSS" },
];

const PAGE_SIZE_OPTIONS = [
  { value: "10", label: "10 / page" },
  { value: "20", label: "20 / page" },
  { value: "50", label: "50 / page" },
];

const MODE_OPTIONS = [
  { value: "auto", label: "Auto" },
  { value: "product", label: "Product" },
  { value: "text", label: "Full Text" },
];

const numberFormatter = new Intl.NumberFormat("en-US");

function toPositiveInt(value: string | null, fallback: number): number {
  if (!value) return fallback;
  const parsed = Number(value);
  if (!Number.isInteger(parsed) || parsed <= 0) {
    return fallback;
  }
  return parsed;
}

function formatSourceName(value: string) {
  return value
    .replace(/_/g, " ")
    .toLowerCase()
    .replace(/\b\w/g, (letter) => letter.toUpperCase());
}

export function CveSearchPageClient() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const pathname = usePathname();

  const q = searchParams.get("q") ?? "";
  const severity = searchParams.get("severity") ?? "ALL";
  const year = searchParams.get("year") ?? "ALL";
  const kev = searchParams.get("kev") ?? "ANY";
  const sort = searchParams.get("sort") ?? "RELEVANCE";
  const rawMode = (searchParams.get("mode") ?? "auto").toLowerCase();
  const mode = rawMode === "product" || rawMode === "text" ? rawMode : "auto";
  const page = toPositiveInt(searchParams.get("page"), 1);
  const pageSize = Math.min(toPositiveInt(searchParams.get("pageSize"), 20), 50);

  const [input, setInput] = useState(q);
  const [result, setResult] = useState<SearchApiResponse | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [refreshToken, setRefreshToken] = useState(0);

  const debouncedInput = useDebouncedValue(input, 300);

  useEffect(() => {
    setInput(q);
  }, [q]);

  const requestQuery = useMemo(() => {
    const params = new URLSearchParams();
    const debouncedQuery = debouncedInput.trim();
    if (debouncedQuery.length > 0) {
      params.set("q", debouncedQuery);
    }
    params.set("mode", mode);
    if (severity !== "ALL") params.set("severity", severity);
    if (year !== "ALL") params.set("year", year);
    if (kev !== "ANY") params.set("kev", kev);
    params.set("sort", sort);
    params.set("page", String(page));
    params.set("pageSize", String(pageSize));
    return params;
  }, [debouncedInput, mode, severity, year, kev, sort, page, pageSize]);

  useEffect(() => {
    if (debouncedInput === q) return;
    const next = new URLSearchParams(searchParams.toString());

    if (debouncedInput.trim().length > 0) {
      next.set("q", debouncedInput.trim());
    } else {
      next.delete("q");
    }

    next.set("page", "1");
    router.replace(`${pathname}?${next.toString()}`, { scroll: false });
  }, [debouncedInput, q, router, pathname, searchParams]);

  useEffect(() => {
    const controller = new AbortController();

    async function run(): Promise<void> {
      setIsLoading(true);
      setError(null);

      try {
        const response = await fetch(`/api/cves/search?${requestQuery.toString()}`, {
          method: "POST",
          signal: controller.signal,
          cache: "no-store",
          headers: {
            Accept: "application/json",
          },
        });

        if (!response.ok) {
          throw new Error(`Search request failed with status ${response.status}`);
        }

        const payload = (await response.json()) as SearchApiResponse;
        setResult(payload);
      } catch (fetchError) {
        if (controller.signal.aborted) return;
        setError(fetchError instanceof Error ? fetchError.message : "Failed to search CVEs");
      } finally {
        if (!controller.signal.aborted) {
          setIsLoading(false);
        }
      }
    }

    run().catch(() => {
      setError("Failed to search CVEs");
      setIsLoading(false);
    });

    return () => controller.abort();
  }, [requestQuery, refreshToken]);

  function updateQuery(updates: Record<string, string>): void {
    const next = new URLSearchParams(searchParams.toString());

    for (const [key, value] of Object.entries(updates)) {
      if (value === "ALL" || value === "ANY" || value === "auto" || value === "") {
        next.delete(key);
      } else {
        next.set(key, value);
      }
    }

    router.push(`${pathname}?${next.toString()}`, { scroll: false });
  }

  const canGoPrev = page > 1;
  const canGoNext = (result?.data.length ?? 0) >= pageSize;
  const hasQuery = q.trim().length > 0;

  const pageStats = useMemo(() => {
    const data = result?.data ?? [];
    const kevCount = data.filter((item) => item.kev.isKnownExploited).length;
    const criticalCount = data.filter((item) => item.severity === "CRITICAL").length;
    const highCount = data.filter((item) => item.severity === "HIGH").length;
    const scored = data.filter((item) => typeof item.cvss.baseScore === "number");
    const avgCvss =
      scored.length > 0
        ? scored.reduce((sum, item) => sum + (item.cvss.baseScore || 0), 0) / scored.length
        : 0;

    return {
      total: data.length,
      kevCount,
      criticalCount,
      highCount,
      avgCvss,
    };
  }, [result]);

  if (isLoading && !result) {
    return (
      <DashboardLayout>
        <div className="flex min-h-[60vh] items-center justify-center">
          <ShieldLoader size="lg" variant="cyber" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-5">
        <PageHeader
          title="CVE Search"
          description="Query vulnerabilities with severity, KEV, and temporal filters to prioritize investigation and patch execution faster."
          badge={
            <>
              <Database size={12} className="mr-2" />
              CVE Intelligence
            </>
          }
          actions={
            <div className="flex w-full flex-wrap items-center gap-2 xl:w-auto xl:justify-end">
              <button
                type="button"
                onClick={() => setRefreshToken((current) => current + 1)}
                className="inline-flex flex-none items-center gap-1.5 whitespace-nowrap rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)] px-3 py-1.5 text-xs font-medium text-[var(--text-primary)] transition-all duration-200 hover:-translate-y-px hover:bg-[var(--bg-elevated)] active:translate-y-0"
              >
                <RefreshCw size={12} className={isLoading ? "animate-spin" : ""} />
                Refresh
              </button>
              <Link
                href="/threats"
                className="inline-flex flex-none items-center gap-1.5 whitespace-nowrap rounded-lg border border-sky-300/40 bg-sky-300/15 px-3 py-1.5 text-xs font-medium text-sky-800 transition-all duration-200 hover:-translate-y-px hover:bg-sky-300/25 active:translate-y-0 dark:border-sky-300/30 dark:bg-sky-300/10 dark:text-sky-100 dark:hover:bg-sky-300/20"
              >
                <Target size={12} />
                Threat Console
              </Link>
            </div>
          }
          stats={[
            { label: "Results", value: numberFormatter.format(pageStats.total), icon: Search },
            { label: "Critical", value: numberFormatter.format(pageStats.criticalCount), icon: AlertTriangle },
            { label: "KEV Flagged", value: numberFormatter.format(pageStats.kevCount), icon: ShieldCheck },
            { label: "Avg CVSS", value: Number(pageStats.avgCvss.toFixed(1)), icon: Database },
          ]}
        />

        <section className="rounded-2xl border border-indigo-300/65 bg-indigo-100/80 p-4 dark:border-indigo-400/25 dark:bg-indigo-500/10">
          <div className="mb-2 flex items-center justify-between">
            <h3 className="text-sm font-semibold text-indigo-950 dark:text-indigo-900">Threat-Active CVEs</h3>
            <span className="text-[10px] uppercase tracking-wide text-indigo-900 dark:text-indigo-900">
              {numberFormatter.format(pageStats.kevCount)} Active
            </span>
          </div>
          <div className="max-h-[140px] space-y-1.5 overflow-y-auto">
            {result?.data
              .filter((cve) => cve.kev.isKnownExploited)
              .slice(0, 10)
              .map((cve) => (
                <Link
                  key={cve.cveId}
                  href={`/cves/${cve.cveId}`}
                  className="flex items-center justify-between gap-2 rounded border border-indigo-300/70 bg-indigo-100/85 p-2 transition-all hover:bg-indigo-200/85 dark:border-indigo-400/20 dark:bg-indigo-500/10 dark:hover:border-indigo-400/40 dark:hover:bg-indigo-500/15"
                >
                  <div className="min-w-0 flex-1">
                    <p className="text-xs font-semibold text-indigo-950 dark:text-indigo-100">{cve.cveId}</p>
                    <p className="truncate text-[10px] text-indigo-900 dark:text-indigo-300">
                      {cve.title || cve.description}
                    </p>
                  </div>
                  <span className={cn("rounded px-1.5 py-0.5 text-[10px]", severityBadgeClass(cve.severity))}>
                    {cve.severity}
                  </span>
                </Link>
              ))}
            {pageStats.kevCount === 0 && (
              <div className="py-4 text-center text-xs text-indigo-900 dark:text-indigo-900">
                No threat-active CVEs in current results
              </div>
            )}
          </div>
        </section>

        <section className="rounded-2xl border border-[var(--border-color)] bg-[var(--bg-card)] p-3 sm:p-4">
          <label className="relative block">
            <Search
              className="pointer-events-none absolute left-4 top-1/2 -translate-y-1/2 text-[var(--text-muted)]"
              size={16}
            />
            <input
              type="text"
              placeholder="Search CVEs, products, vendors, keywords (e.g., React, OpenSSL, CVE-2024-xxxx)"
              className="w-full rounded-lg border border-[var(--border-color)] bg-[var(--bg-secondary)] py-2.5 pl-11 pr-4 text-sm text-[var(--text-primary)] transition-all focus:border-blue-500/50 focus:outline-none focus:ring-2 focus:ring-blue-500/50"
              value={input}
              onChange={(event) => setInput(event.target.value)}
            />
          </label>

          {/* Primary Filters Row */}
          <div className="flex flex-wrap items-center gap-3 lg:gap-4 mt-4">
            {/* Search Mode */}
            <div className="flex flex-col gap-1.5">
              <label className="text-xs text-[var(--text-muted)] font-medium">Mode</label>
              <select
                value={mode}
                onChange={(e) => updateQuery({ mode: e.target.value, page: "1" })}
                className="min-w-[130px] rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)] px-3 py-2 text-sm text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-blue-500/50"
              >
                {MODE_OPTIONS.map((option) => (
                  <option key={option.value} value={option.value}>
                    {option.label}
                  </option>
                ))}
              </select>
            </div>

            {/* Severity */}
            <div className="flex flex-col gap-1.5">
              <label className="text-xs text-[var(--text-muted)] font-medium">Severity</label>
              <select
                value={severity}
                onChange={(e) => updateQuery({ severity: e.target.value, page: "1" })}
                className="min-w-[140px] rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)] px-3 py-2 text-sm text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-blue-500/50"
              >
                {SEVERITY_OPTIONS.map((option) => (
                  <option key={option.value} value={option.value}>
                    {option.label}
                  </option>
                ))}
              </select>
            </div>

            {/* Year */}
            <div className="flex flex-col gap-1.5">
              <label className="text-xs text-[var(--text-muted)] font-medium">Year</label>
              <select
                value={year}
                onChange={(e) => updateQuery({ year: e.target.value, page: "1" })}
                className="min-w-[120px] rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)] px-3 py-2 text-sm text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-blue-500/50"
              >
                {YEAR_OPTIONS.map((option) => (
                  <option key={option.value} value={option.value}>
                    {option.label}
                  </option>
                ))}
              </select>
            </div>

            {/* Known Exploited */}
            <div className="flex flex-col gap-1.5">
              <label className="text-xs text-[var(--text-muted)] font-medium flex items-center gap-1">
                <span className="text-orange-600 dark:text-orange-400"></span>
                Known Exploited
              </label>
              <label className="flex items-center gap-2 bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg px-3 py-2 cursor-pointer hover:bg-[var(--bg-tertiary)]/80 transition-colors min-w-[120px]">
                <input
                  type="checkbox"
                  checked={kev === "KEV_ONLY"}
                  onChange={(e) => updateQuery({ kev: e.target.checked ? "KEV_ONLY" : "ANY", page: "1" })}
                  className="w-4 h-4 rounded bg-[var(--bg-secondary)] border-[var(--border-color)] text-orange-500 focus:ring-2 focus:ring-orange-500/50"
                />
                <span className="text-sm text-[var(--text-primary)]">KEV Only</span>
              </label>
            </div>

            {/* Sort By */}
            <div className="flex flex-col gap-1.5">
              <label className="text-xs text-[var(--text-muted)] font-medium">Sort By</label>
              <select
                value={sort}
                onChange={(e) => updateQuery({ sort: e.target.value, page: "1" })}
                className="min-w-[160px] rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)] px-3 py-2 text-sm text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-blue-500/50"
              >
                {SORT_OPTIONS.map((option) => (
                  <option key={option.value} value={option.value}>
                    {option.label}
                  </option>
                ))}
              </select>
            </div>

            {/* Page Size */}
            <div className="flex flex-col gap-1.5">
              <label className="text-xs text-[var(--text-muted)] font-medium">Page Size</label>
              <select
                value={String(pageSize)}
                onChange={(e) => updateQuery({ pageSize: e.target.value, page: "1" })}
                className="min-w-[110px] rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)] px-3 py-2 text-sm text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-blue-500/50"
              >
                {PAGE_SIZE_OPTIONS.map((option) => (
                  <option key={option.value} value={option.value}>
                    {option.label}
                  </option>
                ))}
              </select>
            </div>

            {/* Advanced Button - Placeholder */}
            <div className="flex flex-col gap-1.5 ml-auto">
              <label className="text-xs text-transparent font-medium select-none">.</label>
              <button
                className="flex items-center gap-2 rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)] px-4 py-2 text-sm font-medium text-[var(--text-primary)] transition-all hover:bg-[var(--bg-tertiary)]/80"
                disabled
                title="Advanced filters coming soon"
              >
                Advanced
                <ChevronDown size={14} />
              </button>
            </div>
          </div>
        </section>

        {result?.meta.partial && result.meta.warnings.length > 0 ? (
          <section className="rounded-2xl border border-amber-500/40 bg-amber-500/10 p-3 text-sm text-amber-900 dark:text-amber-200">
            <div className="flex gap-2">
              <AlertTriangle size={16} className="mt-0.5" />
              <div>{result.meta.warnings.join(" | ")}</div>
            </div>
          </section>
        ) : null}

        {error ? (
          <section className="rounded-2xl border border-red-500/40 bg-red-500/10 p-4 text-red-800 dark:text-red-200">
            {error}
          </section>
        ) : null}

        <section className="grid gap-5 xl:grid-cols-12">
          <div className="xl:col-span-8">
            <article className="overflow-hidden rounded-2xl border border-[var(--border-color)] bg-[var(--bg-card)]">
              <div className="flex items-center justify-between border-b border-[var(--border-color)] px-5 py-4">
                <div>
                  <h2 className="text-base font-semibold text-[var(--text-primary)]">CVE Results</h2>
                  <p className="text-sm text-[var(--text-secondary)]">
                    {result ? `Showing ${result.data.length} results on this page` : "Showing 0 results"}
                  </p>
                </div>
                <span className="text-xs text-[var(--text-muted)]">Page {page}</span>
              </div>

              {result && result.data.length > 0 ? (
                <div className="divide-y divide-[var(--border-color)]">
                  {result.data.map((cve, index) => (
                    <Link
                      key={cve.cveId}
                      href={`/cves/${cve.cveId}`}
                      className="group block px-5 py-4 transition-all duration-200 hover:bg-[var(--bg-elevated)]/70 animate-in fade-in slide-in-from-left-2"
                      style={{ animationDelay: `${index * 30}ms`, animationFillMode: 'backwards' }}
                    >
                      <div className="flex flex-wrap items-center gap-2 mb-2">
                        <span className="font-semibold text-sky-700 dark:text-sky-300">{cve.cveId}</span>
                        <span className={severityBadgeClass(cve.severity)}>{cve.severity}</span>
                        {cve.kev.isKnownExploited ? (
                          <span className="inline-flex items-center gap-1 rounded border border-orange-500/30 bg-orange-500/20 px-2 py-0.5 text-xs text-orange-800 dark:text-orange-300">
                            <ShieldCheck size={12} /> KEV
                          </span>
                        ) : null}
                      </div>

                      <h3 className="text-sm font-semibold text-[var(--text-primary)] transition-colors duration-200 group-hover:text-sky-700 dark:group-hover:text-sky-200 sm:text-base">
                        {cve.title || cve.cveId}
                      </h3>
                      <p className="mt-1 text-sm text-[var(--text-secondary)] line-clamp-2">
                        {cve.description}
                      </p>

                      <div className="mt-3 flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-[var(--text-muted)]">
                        <span>CVSS: {formatScore(cve.cvss.baseScore, 1)}</span>
                        <span>EPSS: {formatScore(cve.epss.score, 3)}</span>
                        <span>Updated: {formatDate(cve.lastModified)}</span>
                        <span>Published: {formatDate(cve.published)}</span>
                      </div>

                      <div className="mt-3 inline-flex items-center gap-1 text-xs font-medium text-[var(--text-muted)] transition-colors duration-200 group-hover:text-sky-700 dark:group-hover:text-sky-200">
                        View details <ChevronRight size={13} />
                      </div>
                    </Link>
                  ))}
                </div>
              ) : (
                <div className="p-12 text-center text-[var(--text-secondary)]">
                  {hasQuery ? "No CVEs found for this query." : "Type to search CVEs."}
                </div>
              )}
            </article>

            <div className="mt-4 flex items-center justify-between px-2">
              <button
                className="inline-flex items-center justify-center gap-2 rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)] px-4 py-2 text-sm font-medium text-[var(--text-primary)] transition-all duration-200 hover:-translate-y-px hover:bg-[var(--bg-elevated)] active:translate-y-0 disabled:opacity-40 disabled:hover:translate-y-0"
                disabled={!canGoPrev}
                onClick={() => updateQuery({ page: String(page - 1) })}
              >
                Previous
              </button>

              <div className="text-sm text-[var(--text-secondary)]">Page {page}</div>

              <button
                className="inline-flex items-center justify-center gap-2 rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)] px-4 py-2 text-sm font-medium text-[var(--text-primary)] transition-all duration-200 hover:-translate-y-px hover:bg-[var(--bg-elevated)] active:translate-y-0 disabled:opacity-40 disabled:hover:translate-y-0"
                disabled={!canGoNext}
                onClick={() => updateQuery({ page: String(page + 1) })}
              >
                Next
              </button>
            </div>
          </div>

          <aside className="xl:col-span-4 space-y-4">
            <section className="rounded-2xl border border-[var(--border-color)] bg-[var(--bg-card)] p-5 animate-in fade-in slide-in-from-right-4 duration-500" style={{ animationDelay: '300ms', animationFillMode: 'backwards' }}>
              <h3 className="text-base font-semibold text-[var(--text-primary)]">Source Attribution</h3>
              <p className="mt-1 text-sm text-[var(--text-secondary)]">Feeds used for this query</p>
              <div className="mt-4 flex flex-wrap gap-2">
                {(result?.meta.sourcesUsed ?? []).length > 0 ? (
                  result?.meta.sourcesUsed.map((source, index) => (
                    <span
                      key={source}
                      className="rounded-full border border-[var(--border-color)] bg-[var(--bg-tertiary)] px-3 py-1 text-xs text-[var(--text-secondary)] transition-all duration-200 hover:bg-[var(--bg-elevated)] hover:-translate-y-px animate-in fade-in zoom-in-95"
                      style={{ animationDelay: `${index * 30}ms`, animationFillMode: 'backwards' }}
                    >
                      {formatSourceName(source)}
                    </span>
                  ))
                ) : (
                  <span className="text-sm text-[var(--text-secondary)]">No sources loaded yet.</span>
                )}
              </div>
            </section>
          </aside>
        </section>
      </div>
    </DashboardLayout>
  );
}
