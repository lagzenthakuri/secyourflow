import type { NormalizedCve, Severity, SourceAttribution } from "./types";
import { parseDateToIso } from "./date";

const SEVERITY_ORDER: Record<Severity, number> = {
  UNKNOWN: 0,
  LOW: 1,
  MEDIUM: 2,
  HIGH: 3,
  CRITICAL: 4,
};

export function normalizeCveId(value: string): string {
  return value.trim().toUpperCase();
}

export function severityWeight(severity: Severity): number {
  return SEVERITY_ORDER[severity];
}

export function severityFromCvss(score: number | null | undefined): Severity {
  if (score === null || score === undefined) return "UNKNOWN";
  if (score >= 9) return "CRITICAL";
  if (score >= 7) return "HIGH";
  if (score >= 4) return "MEDIUM";
  return "LOW";
}

export function severityFromText(value: string | null | undefined): Severity {
  const normalized = value?.trim().toUpperCase();
  if (!normalized) return "UNKNOWN";

  if (normalized.includes("CRITICAL")) return "CRITICAL";
  if (normalized.includes("HIGH")) return "HIGH";
  if (normalized.includes("MEDIUM") || normalized.includes("MODERATE")) return "MEDIUM";
  if (normalized.includes("LOW")) return "LOW";

  return "UNKNOWN";
}

export function chooseBetterSeverity(current: Severity, next: Severity): Severity {
  return severityWeight(next) > severityWeight(current) ? next : current;
}

export function createBaseNormalizedCve(cveId: string): NormalizedCve {
  return {
    cveId: normalizeCveId(cveId),
    title: null,
    description: "",
    published: null,
    lastModified: null,
    severity: "UNKNOWN",
    cvss: {
      version: null,
      baseScore: null,
      vector: null,
    },
    epss: {
      score: null,
      percentile: null,
      asOf: null,
    },
    kev: {
      isKnownExploited: false,
      dateAdded: null,
      dueDate: null,
      notes: null,
    },
    affected: {
      cpe: [],
      packages: [],
    },
    references: [],
    sourceAttribution: [],
  };
}

export function mergeAttributions(
  initial: SourceAttribution[],
  additions: SourceAttribution[],
): SourceAttribution[] {
  const map = new Map<string, SourceAttribution>();

  for (const item of [...initial, ...additions]) {
    const key = `${item.source}|${item.url ?? ""}`;
    map.set(key, item);
  }

  return Array.from(map.values());
}

export function parseIsoOrNull(value: unknown): string | null {
  return parseDateToIso(value);
}

export function nonEmpty(value: string | null | undefined): string | null {
  if (!value) return null;
  const trimmed = value.trim();
  return trimmed.length > 0 ? trimmed : null;
}

function descriptionWords(value: string): string[] {
  return value
    .replace(/[^a-zA-Z0-9\s-]/g, " ")
    .split(/\s+/)
    .map((word) => word.trim())
    .filter((word) => word.length > 0);
}

export function titleFromDescription(description: string): string | null {
  const words = descriptionWords(description);
  if (words.length < 8) {
    return null;
  }

  const sliceLength = words.length > 12 ? 10 : words.length;
  return words.slice(0, sliceLength).join(" ");
}

export function normalizeCveTitle(
  title: string | null | undefined,
  description: string,
  cveId: string,
): string {
  const explicitTitle = nonEmpty(title);
  if (explicitTitle) {
    return explicitTitle;
  }

  const inferred = titleFromDescription(description);
  if (inferred) {
    return inferred;
  }

  return normalizeCveId(cveId);
}
