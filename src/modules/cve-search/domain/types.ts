export type Severity = "LOW" | "MEDIUM" | "HIGH" | "CRITICAL" | "UNKNOWN";

export interface CvssScore {
  version: string | null;
  baseScore: number | null;
  vector: string | null;
}

export interface EpssScore {
  score: number | null;
  percentile: number | null;
  asOf: string | null;
}

export interface KevInfo {
  isKnownExploited: boolean;
  dateAdded: string | null;
  dueDate: string | null;
  notes: string | null;
}

export interface AffectedPackage {
  ecosystem: string;
  name: string;
  ranges?: string[];
}

export interface CveReference {
  url: string;
  source: string;
}

export interface SourceAttribution {
  source: string;
  url?: string;
}

export interface NormalizedCve {
  cveId: string;
  title: string | null;
  description: string;
  published: string | null;
  lastModified: string | null;
  severity: Severity;
  cvss: CvssScore;
  epss: EpssScore;
  kev: KevInfo;
  affected: {
    cpe: string[];
    packages: AffectedPackage[];
  };
  references: CveReference[];
  sourceAttribution: SourceAttribution[];
}

export type SearchSort = "relevance" | "newest" | "cvss" | "epss";
export type SearchMode = "auto" | "product" | "text";

export interface SearchQuery {
  q: string;
  mode?: SearchMode;
  page: number;
  pageSize: number;
  from?: string;
  to?: string;
  sort: SearchSort;
  severity?: Severity | "ALL";
  kev?: "ANY" | "KEV_ONLY" | "NOT_KEV";
  epssMin?: number;
  epssMax?: number;
  cvssMin?: number;
  cvssMax?: number;
}

export interface SearchMeta {
  query: string;
  page: number;
  pageSize: number;
  tookMs: number;
  sourcesUsed: string[];
  partial: boolean;
  warnings: string[];
}

export interface SearchResponse {
  meta: SearchMeta;
  data: NormalizedCve[];
}

export interface DetailMeta {
  cveId: string;
  tookMs: number;
  sourcesUsed: string[];
  partial: boolean;
  warnings: string[];
}

export interface DetailResponse {
  meta: DetailMeta;
  data: NormalizedCve;
}

export interface AdapterSearchOptions {
  page: number;
  pageSize: number;
  from?: string;
  to?: string;
  signal?: AbortSignal;
}

export interface AdapterResult<T> {
  data: T;
  warnings: string[];
  sourceUsed: string;
}

export interface SourceCallOptions {
  signal?: AbortSignal;
}

export interface SourceFailure {
  source: string;
  warning: string;
}

export interface SourceSuccess<T> {
  source: string;
  value: T;
  warnings: string[];
}

export interface SearchSourceResult {
  cves: NormalizedCve[];
  warnings: string[];
  sourcesUsed: string[];
}

export interface CveSearchConfig {
  nvdApiBaseUrl: string;
  mitreApiBaseUrl: string;
  cisaKevUrl: string;
  epssApiBaseUrl: string;
  enrichment: {
    enabled: boolean;
  };
  timeouts: {
    perSourceMs: number;
    overallRequestMs: number;
  };
  retries: {
    maxRetries: number;
    baseBackoffMs: number;
  };
  circuitBreaker: {
    failureThreshold: number;
    openMs: number;
  };
  cacheTtlMs: {
    searchResults: number;
    cveById: number;
    kevCatalog: number;
    epssScores: number;
  };
}
