#!/usr/bin/env bash
set -euo pipefail

if [ "${RUN_LIVE:-0}" != "1" ]; then
  printf 'FAIL: RUN_LIVE=1 is required for random-cve-sampler.sh\n'
  printf 'Action: RUN_LIVE=1 BASE_URL=http://localhost:3000 bash scripts/random-cve-sampler.sh\n'
  exit 2
fi

BASE_URL="${BASE_URL:-http://localhost:3000}"
NVD_API_BASE="${NVD_API_BASE:-https://services.nvd.nist.gov/rest/json/cves/2.0}"
SEED="${SEED:-20260208}"
TARGET_GENERATED="${TARGET_GENERATED:-150}"
MIN_EXISTING="${MIN_EXISTING:-50}"
MAX_ATTEMPTS="${MAX_ATTEMPTS:-4000}"
TIMEOUT_SECONDS="${TIMEOUT_SECONDS:-20}"
SKIP_LOCAL_API="${SKIP_LOCAL_API:-0}"
NVD_API_KEY="${CVE_NVD_API_KEY:-${NVD_API_KEY:-}}"

TMP_DIR="$(mktemp -d)"
SEEN_FILE="$TMP_DIR/seen.txt"
RNG_STATE="$SEED"
RNG_OUT=0
FAILURES=0
PASSES=0
API_METHOD=""

cleanup() {
  rm -rf "$TMP_DIR"
}
trap cleanup EXIT

pass() {
  PASSES=$((PASSES + 1))
  printf 'PASS: %s\n' "$1"
}

fail() {
  FAILURES=$((FAILURES + 1))
  printf 'FAIL: %s\n' "$1"
}

fatal() {
  printf 'FAIL: %s\n' "$1"
  exit 2
}

rng_next() {
  RNG_STATE=$(( (1103515245 * RNG_STATE + 12345) % 2147483648 ))
  RNG_OUT="$RNG_STATE"
}

rand_between() {
  local min="$1"
  local max="$2"
  rng_next
  RNG_OUT=$(( min + (RNG_OUT % (max - min + 1)) ))
}

probe_api_method() {
  if [ "$SKIP_LOCAL_API" = "1" ]; then
    return
  fi

  local probe_url="${BASE_URL}/api/cves/search?q=CVE-2018-6341&page=1&pageSize=5&mode=auto"
  local get_code post_code

  get_code="$(curl -sS --max-time "$TIMEOUT_SECONDS" -o "$TMP_DIR/probe-get.json" -w '%{http_code}' "$probe_url" || printf '000')"
  if [ "$get_code" = "200" ]; then
    API_METHOD="GET"
    pass "Detected local API method GET"
    return
  fi

  post_code="$(curl -sS --max-time "$TIMEOUT_SECONDS" -X POST -H 'Accept: application/json' -o "$TMP_DIR/probe-post.json" -w '%{http_code}' "$probe_url" || printf '000')"
  if [ "$post_code" = "200" ]; then
    API_METHOD="POST"
    pass "Detected local API method POST"
    return
  fi

  fatal "Local API not reachable at ${BASE_URL}/api/cves/search (GET=${get_code}, POST=${post_code})"
}

api_request() {
  local query="$1"
  local out="$2"
  local url="${BASE_URL}/api/cves/search?${query}"

  if [ "$API_METHOD" = "POST" ]; then
    curl -sS --max-time "$TIMEOUT_SECONDS" -X POST -H 'Accept: application/json' -o "$out" -w '%{http_code}' "$url" || printf '000'
  else
    curl -sS --max-time "$TIMEOUT_SECONDS" -o "$out" -w '%{http_code}' "$url" || printf '000'
  fi
}

nvd_request_by_id() {
  local cve_id="$1"
  local out="$2"
  local url="${NVD_API_BASE}?cveId=${cve_id}&resultsPerPage=1"
  local attempt code backoff

  for attempt in 1 2 3 4; do
    if [ -n "$NVD_API_KEY" ]; then
      code="$(curl -sS --max-time "$TIMEOUT_SECONDS" -H "Accept: application/json" -H "apiKey: ${NVD_API_KEY}" -o "$out" -w '%{http_code}' "$url" || printf '000')"
    else
      code="$(curl -sS --max-time "$TIMEOUT_SECONDS" -H "Accept: application/json" -o "$out" -w '%{http_code}' "$url" || printf '000')"
    fi

    if [ "$code" = "200" ]; then
      printf '%s' "$code"
      return 0
    fi

    if [ "$code" = "429" ] || [ "$code" = "500" ] || [ "$code" = "502" ] || [ "$code" = "503" ] || [ "$code" = "504" ]; then
      backoff=$((2 ** attempt))
      sleep "$backoff"
      continue
    fi

    printf '%s' "$code"
    return 0
  done

  printf '%s' "$code"
  return 0
}

existing_in_nvd() {
  local cve_id="$1"
  local file="$2"
  grep -Eq "\"id\"[[:space:]]*:[[:space:]]*\"${cve_id}\"" "$file"
}

verify_local_api_has_id() {
  local cve_id="$1"
  local body="$TMP_DIR/local-${cve_id}.json"
  local status

  status="$(api_request "q=${cve_id}&page=1&pageSize=5&mode=auto" "$body")"
  if [ "$status" != "200" ]; then
    fail "Local API lookup failed for ${cve_id} (HTTP ${status})"
    return 1
  fi

  if grep -Eq "\"cveId\"[[:space:]]*:[[:space:]]*\"${cve_id}\"" "$body"; then
    pass "Local API returned ${cve_id}"
    return 0
  fi

  fail "Local API did not return ${cve_id} after NVD existence confirmation"
  return 1
}

printf 'Running deterministic random CVE sampler\n'
printf 'Seed=%s TargetGenerated=%s MinExisting=%s MaxAttempts=%s\n' \
  "$SEED" "$TARGET_GENERATED" "$MIN_EXISTING" "$MAX_ATTEMPTS"
printf 'NVD=%s\n' "$NVD_API_BASE"
if [ "$SKIP_LOCAL_API" != "1" ]; then
  printf 'Local API=%s\n' "$BASE_URL"
fi

probe_api_method

CURRENT_YEAR="$(date +%Y)"
attempts=0
generated=0
existing=0
validated=0

while [ "$attempts" -lt "$MAX_ATTEMPTS" ] && { [ "$generated" -lt "$TARGET_GENERATED" ] || [ "$existing" -lt "$MIN_EXISTING" ]; }; do
  attempts=$((attempts + 1))

  rand_between 1999 "$CURRENT_YEAR"
  year="$RNG_OUT"
  rand_between 1 20000
  seq="$RNG_OUT"
  cve_id="$(printf 'CVE-%04d-%04d' "$year" "$seq")"

  if grep -Fxq "$cve_id" "$SEEN_FILE" 2>/dev/null; then
    continue
  fi
  printf '%s\n' "$cve_id" >> "$SEEN_FILE"
  generated=$((generated + 1))

  nvd_body="$TMP_DIR/nvd-${generated}.json"
  nvd_status="$(nvd_request_by_id "$cve_id" "$nvd_body")"

  if [ "$nvd_status" = "000" ]; then
    fail "NVD request failed for ${cve_id} (network blocked)."
    break
  fi

  if [ "$nvd_status" = "429" ]; then
    fail "NVD rate limit persisted for ${cve_id}. Set NVD_API_KEY/CVE_NVD_API_KEY and re-run."
    break
  fi

  if [ "$nvd_status" != "200" ]; then
    fail "Unexpected NVD status ${nvd_status} for ${cve_id}"
    break
  fi

  if existing_in_nvd "$cve_id" "$nvd_body"; then
    existing=$((existing + 1))
    pass "NVD confirms ${cve_id} exists"

    if [ "$SKIP_LOCAL_API" != "1" ]; then
      if verify_local_api_has_id "$cve_id"; then
        validated=$((validated + 1))
      fi
    fi
  fi
done

if [ "$generated" -lt "$TARGET_GENERATED" ]; then
  fail "Generated only ${generated}/${TARGET_GENERATED} unique random CVE IDs before stopping"
fi

if [ "$existing" -lt "$MIN_EXISTING" ]; then
  fail "Found only ${existing} existing CVEs (< ${MIN_EXISTING}) after ${attempts} attempts"
fi

if [ "$SKIP_LOCAL_API" != "1" ] && [ "$validated" -lt "$MIN_EXISTING" ]; then
  fail "Validated only ${validated}/${MIN_EXISTING} existing CVEs through local API"
fi

printf '\nSummary: attempts=%s generated=%s existing=%s validated=%s pass=%s fail=%s\n' \
  "$attempts" "$generated" "$existing" "$validated" "$PASSES" "$FAILURES"

if [ "$FAILURES" -gt 0 ]; then
  exit 1
fi
