generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String         @id @default(cuid())
  email                 String         @unique
  emailVerified         DateTime?
  name                  String?
  password              String?
  image                 String?
  role                  Role           @default(ANALYST)
  avatar                String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  lastLogin             DateTime?
  organizationId        String?
  totpEnabled           Boolean        @default(false)
  totpSecretEnc         String?
  totpVerifiedAt        DateTime?
  totpRecoveryCodesHash Json?
  totpLastUsedStep      Int?
  accounts              Account[]
  auditLogs             AuditLog[]
  comments              Comment[]
  notifications         Notification[]
  reports               Report[]
  sessions              Session[]
  organization          Organization?  @relation(fields: [organizationId], references: [id])

  @@index([email])
  @@index([organizationId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Organization {
  id                   String                @id @default(cuid())
  name                 String
  domain               String?
  logo                 String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  assets               Asset[]
  audits               Audit[]
  complianceFrameworks ComplianceFramework[]
  policies             Policy[]
  reports              Report[]
  riskEntries          RiskRegister[]
  settings             Setting?
  users                User[]
  vulnerabilities      Vulnerability[]

  @@index([name])
}

model Asset {
  id                 String                   @id @default(cuid())
  name               String
  type               AssetType
  hostname           String?
  ipAddress          String?
  macAddress         String?
  operatingSystem    String?
  version            String?
  environment        Environment              @default(PRODUCTION)
  criticality        Criticality              @default(MEDIUM)
  status             AssetStatus              @default(ACTIVE)
  owner              String?
  department         String?
  location           String?
  cloudProvider      CloudProvider?
  cloudRegion        String?
  cloudAccountId     String?
  tags               String[]
  metadata           Json?
  lastSeen           DateTime?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  organizationId     String
  organization       Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  complianceControls AssetComplianceControl[]
  vulnerabilities    AssetVulnerability[]
  riskEntries        RiskRegister[]

  @@index([name])
  @@index([type])
  @@index([ipAddress])
  @@index([organizationId])
  @@index([criticality])
  @@index([organizationId, criticality])
  @@index([organizationId, environment])
  @@index([organizationId, status])
  @@index([organizationId, type])
  @@index([location])
  @@index([hostname])
}

model Vulnerability {
  id                 String                           @id @default(cuid())
  cveId              String?
  title              String
  description        String?
  severity           Severity
  cvssScore          Float?
  cvssVector         String?
  epssScore          Float?
  epssPercentile     Float?
  cweId              String?
  cweDescription     String?
  isExploited        Boolean                          @default(false)
  exploitMaturity    ExploitMaturity?
  cisaKev            Boolean                          @default(false)
  source             VulnSource
  scannerId          String?
  scannerName        String?
  firstDetected      DateTime                         @default(now())
  lastSeen           DateTime                         @default(now())
  status             VulnStatus                       @default(OPEN)
  solution           String?
  references         String[]
  patchAvailable     Boolean                          @default(false)
  dueDate            DateTime?
  fixedAt            DateTime?
  riskScore          Float?
  businessImpact     String?
  metadata           Json?
  createdAt          DateTime                         @default(now())
  updatedAt          DateTime                         @updatedAt
  organizationId     String
  assets             AssetVulnerability[]
  comments           Comment[]
  riskEntries        RiskRegister[]
  organization       Organization                     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  complianceControls VulnerabilityComplianceControl[]

  @@index([cveId])
  @@index([severity])
  @@index([status])
  @@index([organizationId])
  @@index([isExploited])
  @@index([riskScore])
  @@index([organizationId, severity])
  @@index([organizationId, status])
  @@index([organizationId, isExploited])
  @@index([organizationId, cisaKev])
  @@index([createdAt(sort: Desc)])
  @@index([severity, status])
  @@index([epssScore(sort: Desc)])
}

model AssetVulnerability {
  id              String        @id @default(cuid())
  assetId         String
  vulnerabilityId String
  port            Int?
  protocol        String?
  service         String?
  path            String?
  evidence        String?
  status          VulnStatus    @default(OPEN)
  firstDetected   DateTime      @default(now())
  lastSeen        DateTime      @default(now())
  asset           Asset         @relation(fields: [assetId], references: [id], onDelete: Cascade)
  vulnerability   Vulnerability @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)

  @@unique([assetId, vulnerabilityId])
  @@index([assetId])
  @@index([vulnerabilityId])
  @@index([status])
}

model ComplianceFramework {
  id             String              @id @default(cuid())
  name           String
  version        String?
  description    String?
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  organizationId String
  controls       ComplianceControl[]
  organization   Organization        @relation(fields: [organizationId], references: [id])

  @@index([name])
  @@index([organizationId])
}

model ComplianceControl {
  id                   String                           @id @default(cuid())
  controlId            String
  title                String
  description          String?
  category             String?
  objective            String?
  status               ComplianceStatus                 @default(NOT_ASSESSED)
  implementationStatus ImplementationStatus             @default(NOT_IMPLEMENTED)
  evidence             String?
  notes                String?
  lastAssessed         DateTime?
  nextAssessment       DateTime?
  createdAt            DateTime                         @default(now())
  updatedAt            DateTime                         @updatedAt
  frameworkId          String
  controlType          ControlType                      @default(PREVENTIVE)
  evidenceRequired     String[]
  frequency            ControlFrequency                 @default(ANNUAL)
  mappedControls       Json?
  maturityLevel        Int                              @default(0)
  nistCsfFunction      NistCsfFunction?
  ownerRole            String?
  riskCategory         String?
  assets               AssetComplianceControl[]
  framework            ComplianceFramework              @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  vulnerabilities      VulnerabilityComplianceControl[]

  @@unique([frameworkId, controlId])
  @@index([frameworkId])
  @@index([status])
  @@index([controlId])
  @@index([maturityLevel])
  @@index([nistCsfFunction])
  @@index([frameworkId, status])
}

model AssetComplianceControl {
  id         String            @id @default(cuid())
  assetId    String
  controlId  String
  status     ComplianceStatus  @default(NOT_ASSESSED)
  evidence   String?
  assessedAt DateTime?
  asset      Asset             @relation(fields: [assetId], references: [id], onDelete: Cascade)
  control    ComplianceControl @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@unique([assetId, controlId])
  @@index([assetId])
  @@index([controlId])
}

model VulnerabilityComplianceControl {
  id              String            @id @default(cuid())
  vulnerabilityId String
  controlId       String
  impact          String?
  control         ComplianceControl @relation(fields: [controlId], references: [id], onDelete: Cascade)
  vulnerability   Vulnerability     @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)

  @@unique([vulnerabilityId, controlId])
  @@index([vulnerabilityId])
  @@index([controlId])
}

model ThreatFeed {
  id           String            @id @default(cuid())
  name         String
  source       String
  type         ThreatFeedType
  url          String?
  apiKey       String?
  isActive     Boolean           @default(true)
  lastSync     DateTime?
  syncInterval Int               @default(3600)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  indicators   ThreatIndicator[]

  @@index([name])
  @@index([isActive])
}

model ThreatIndicator {
  id          String        @id @default(cuid())
  type        IndicatorType
  value       String
  confidence  Int?
  severity    Severity?
  firstSeen   DateTime      @default(now())
  lastSeen    DateTime      @default(now())
  expiresAt   DateTime?
  source      String?
  description String?
  tags        String[]
  tacticId    String?
  techniqueId String?
  feedId      String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  feed        ThreatFeed    @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([value])
  @@index([feedId])
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  userId     String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@index([entityType, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
}

model Comment {
  id              String         @id @default(cuid())
  content         String
  entityType      String
  entityId        String
  userId          String
  vulnerabilityId String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  vulnerability   Vulnerability? @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([userId])
}

model ScannerConfig {
  id           String       @id @default(cuid())
  name         String
  type         VulnSource
  endpoint     String?
  apiKey       String?
  username     String?
  password     String?
  isActive     Boolean      @default(true)
  lastSync     DateTime?
  syncInterval Int          @default(86400)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  scanResults  ScanResult[]

  @@index([type])
  @@index([isActive])
}

model ScanResult {
  id         String        @id @default(cuid())
  scanId     String
  startTime  DateTime
  endTime    DateTime?
  status     ScanStatus    @default(RUNNING)
  totalHosts Int           @default(0)
  totalVulns Int           @default(0)
  rawData    Json?
  scannerId  String
  createdAt  DateTime      @default(now())
  scanner    ScannerConfig @relation(fields: [scannerId], references: [id], onDelete: Cascade)

  @@index([scanId])
  @@index([scannerId])
  @@index([status])
}

model RiskSnapshot {
  id               String   @id @default(cuid())
  date             DateTime @default(now())
  totalAssets      Int
  criticalAssets   Int
  totalVulns       Int
  criticalVulns    Int
  highVulns        Int
  mediumVulns      Int
  lowVulns         Int
  exploitedVulns   Int
  cisaKevVulns     Int
  overallRiskScore Float
  complianceScore  Float?
  metadata         Json?

  @@index([date])
}

model Setting {
  id                      String       @id @default(cuid())
  organizationId          String       @unique
  timezone                String       @default("UTC")
  dateFormat              String       @default("MMM DD, YYYY")
  notifyCritical          Boolean      @default(true)
  notifyExploited         Boolean      @default(true)
  notifyCompliance        Boolean      @default(true)
  notifyScan              Boolean      @default(false)
  notifyWeekly            Boolean      @default(true)
  require2FA              Boolean      @default(false)
  sessionTimeout          Int          @default(30)
  passwordPolicy          String       @default("STRONG")
  updatedAt               DateTime     @updatedAt
  aiRiskAssessmentEnabled Boolean      @default(true)
  organization            Organization @relation(fields: [organizationId], references: [id])
}

model Report {
  id             String       @id @default(cuid())
  name           String
  type           String
  description    String?
  format         String       @default("PDF")
  frequency      String?
  status         String       @default("PENDING")
  url            String?
  size           String?
  organizationId String
  userId         String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   @default("INFO")
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([userId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

model RiskRegister {
  id               String        @id @default(cuid())
  assetId          String
  vulnerabilityId  String
  organizationId   String
  riskScore        Float
  impactScore      Float
  likelihoodScore  Float
  status           String        @default("ACTIVE")
  aiAnalysis       Json
  treatmentOption  String?
  responsibleParty String?
  confidence       Float?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  actionPlan       String?
  currentControls  String?
  isResolved       Boolean       @default(false)
  remarks          String?
  riskCategory2    String?
  selectedControls String?
  asset            Asset         @relation(fields: [assetId], references: [id], onDelete: Cascade)
  organization     Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vulnerability    Vulnerability @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([vulnerabilityId])
  @@index([organizationId])
  @@index([organizationId, status])
  @@index([riskScore(sort: Desc)])
  @@index([organizationId, riskScore(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([assetId, vulnerabilityId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Cve {
  id             String                   @id
  cveId          String                   @unique
  description    String
  publishedAt    DateTime
  lastModifiedAt DateTime
  severity       Severity
  cweIds         String[]
  searchVector   Unsupported("tsvector")?
  status         CveStatus                @default(ACTIVE)
  isKev          Boolean                  @default(false)
  epssScore      Float?
  epssPercentile Float?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime
  CveCpe         CveCpe[]
  CveCvss        CveCvss[]
  CveProvenance  CveProvenance[]
  CveReference   CveReference[]
  KevEntry       KevEntry?

  @@index([cveId])
  @@index([cveId], map: "Cve_cveId_pattern_idx")
  @@index([epssScore])
  @@index([isKev, severity])
  @@index([publishedAt(sort: Desc)])
  @@index([severity, publishedAt])
  @@index([status, lastModifiedAt])
  @@index([status, publishedAt])
  @@index([status, severity, publishedAt(sort: Desc)], map: "Cve_status_severity_published_idx")
  @@index([cveId(ops: raw("gin_trgm_ops"))], map: "Cve_cveId_trgm_idx", type: Gin)
  @@index([searchVector], type: Gin)
}

model CveCpe {
  id                    String  @id
  cveId                 String
  cpeUri                String
  vendor                String
  product               String
  version               String
  versionStartIncluding String?
  versionEndExcluding   String?
  vulnerable            Boolean
  Cve                   Cve     @relation(fields: [cveId], references: [cveId])

  @@index([cveId])
  @@index([vendor, product])
}

model CveCvss {
  id                  String @id
  cveId               String
  version             String
  vectorString        String
  baseScore           Float
  baseSeverity        String
  exploitabilityScore Float?
  impactScore         Float?
  Cve                 Cve    @relation(fields: [cveId], references: [cveId])

  @@index([cveId])
}

model CveProvenance {
  id          String   @id
  cveId       String
  source      String
  field       String
  lastUpdated DateTime
  checksum    String
  Cve         Cve      @relation(fields: [cveId], references: [cveId])

  @@index([cveId, source])
  @@index([source, lastUpdated(sort: Desc)])
}

model CveReference {
  id     String   @id
  cveId  String
  url    String
  source String
  tags   String[]
  Cve    Cve      @relation(fields: [cveId], references: [cveId])

  @@index([cveId])
}

model IngestionState {
  id               String    @id
  source           String    @unique
  lastSyncAt       DateTime
  lastSuccessAt    DateTime?
  status           String
  errorMessage     String?
  recordsProcessed Int       @default(0)

  @@index([source])
}

model KevEntry {
  id                String   @id
  cveId             String   @unique
  vulnerabilityName String
  dateAdded         DateTime
  dueDate           DateTime
  requiredAction    String
  notes             String?
  Cve               Cve      @relation(fields: [cveId], references: [cveId])

  @@index([cveId])
  @@index([dueDate])
}

model Policy {
  id             String       @id @default(cuid())
  title          String
  description    String?
  version        String       @default("1.0")
  status         PolicyStatus @default(DRAFT)
  type           String?
  url            String?
  owner          String?
  lastReview     DateTime?
  nextReview     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
}

model Audit {
  id              String       @id @default(cuid())
  title           String
  type            AuditType    @default(INTERNAL)
  status          AuditStatus  @default(PLANNED)
  scope           String?
  findings        String?
  recommendations String?
  startDate       DateTime?
  endDate         DateTime?
  periodStart     DateTime?
  periodEnd       DateTime?
  auditor         String?
  reportUrl       String?
  organizationId  String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@index([type])
}

enum Role {
  IT_OFFICER
  PENTESTER
  ANALYST
  MAIN_OFFICER
}

enum AssetType {
  SERVER
  WORKSTATION
  NETWORK_DEVICE
  CLOUD_INSTANCE
  CONTAINER
  DATABASE
  APPLICATION
  API
  DOMAIN
  CERTIFICATE
  IOT_DEVICE
  MOBILE_DEVICE
  OTHER
}

enum Environment {
  PRODUCTION
  STAGING
  DEVELOPMENT
  TESTING
  DR
}

enum Criticality {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFORMATIONAL
}

enum AssetStatus {
  ACTIVE
  INACTIVE
  DECOMMISSIONED
  MAINTENANCE
}

enum CloudProvider {
  AWS
  AZURE
  GCP
  ORACLE
  IBM
  ALIBABA
  OTHER
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFORMATIONAL
}

enum VulnStatus {
  OPEN
  IN_PROGRESS
  MITIGATED
  FIXED
  ACCEPTED
  FALSE_POSITIVE
}

enum VulnSource {
  NESSUS
  OPENVAS
  NMAP
  TRIVY
  QUALYS
  RAPID7
  CROWDSTRIKE
  MANUAL
  API
  OTHER
  TENABLE
}

enum ExploitMaturity {
  NOT_DEFINED
  UNPROVEN
  POC
  FUNCTIONAL
  HIGH
}

enum ComplianceStatus {
  COMPLIANT
  NON_COMPLIANT
  PARTIALLY_COMPLIANT
  NOT_ASSESSED
  NOT_APPLICABLE
}

enum ImplementationStatus {
  IMPLEMENTED
  PARTIALLY_IMPLEMENTED
  PLANNED
  NOT_IMPLEMENTED
  NOT_APPLICABLE
}

enum ThreatFeedType {
  CVE
  MALWARE
  IOC
  THREAT_ACTOR
  CAMPAIGN
}

enum IndicatorType {
  IP_ADDRESS
  DOMAIN
  URL
  FILE_HASH_MD5
  FILE_HASH_SHA1
  FILE_HASH_SHA256
  EMAIL
  CVE
  REGISTRY_KEY
  USER_AGENT
}

enum ScanStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum CveStatus {
  ACTIVE
  REJECTED
  RESERVED
}

enum ControlType {
  PREVENTIVE
  DETECTIVE
  CORRECTIVE
}

enum ControlFrequency {
  CONTINUOUS
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
}

enum NistCsfFunction {
  GOVERN
  IDENTIFY
  PROTECT
  DETECT
  RESPOND
  RECOVER
}

enum PolicyStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  UNDER_REVIEW
}

enum AuditType {
  INTERNAL
  EXTERNAL
  REGULATORY
  THIRD_PARTY
}

enum AuditStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
