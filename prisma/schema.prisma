generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String        @id @default(cuid())
  email          String        @unique
  emailVerified  DateTime?
  name           String?
  password       String?
  image          String?
  role           Role          @default(ANALYST)
  avatar         String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  lastLogin      DateTime?
  organizationId String?
  accounts       Account[]
  auditLogs      AuditLog[]
  comments       Comment[]
  reports        Report[]
  sessions       Session[]
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@index([email])
  @@index([organizationId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Organization {
  id                   String                @id @default(cuid())
  name                 String
  domain               String?
  logo                 String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  assets               Asset[]
  complianceFrameworks ComplianceFramework[]
  reports              Report[]
  settings             Setting?
  users                User[]
  vulnerabilities      Vulnerability[]

  @@index([name])
}

model Asset {
  id                 String                   @id @default(cuid())
  name               String
  type               AssetType
  hostname           String?
  ipAddress          String?
  macAddress         String?
  operatingSystem    String?
  version            String?
  environment        Environment              @default(PRODUCTION)
  criticality        Criticality              @default(MEDIUM)
  status             AssetStatus              @default(ACTIVE)
  owner              String?
  department         String?
  location           String?
  cloudProvider      CloudProvider?
  cloudRegion        String?
  cloudAccountId     String?
  tags               String[]
  metadata           Json?
  lastSeen           DateTime?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  organizationId     String
  organization       Organization             @relation(fields: [organizationId], references: [id])
  complianceControls AssetComplianceControl[]
  vulnerabilities    AssetVulnerability[]

  @@index([name])
  @@index([type])
  @@index([ipAddress])
  @@index([organizationId])
  @@index([criticality])
}

model Vulnerability {
  id                 String                           @id @default(cuid())
  cveId              String?
  title              String
  description        String?
  severity           Severity
  cvssScore          Float?
  cvssVector         String?
  epssScore          Float?
  epssPercentile     Float?
  cweId              String?
  cweDescription     String?
  isExploited        Boolean                          @default(false)
  exploitMaturity    ExploitMaturity?
  cisaKev            Boolean                          @default(false)
  source             VulnSource
  scannerId          String?
  scannerName        String?
  firstDetected      DateTime                         @default(now())
  lastSeen           DateTime                         @default(now())
  status             VulnStatus                       @default(OPEN)
  solution           String?
  references         String[]
  patchAvailable     Boolean                          @default(false)
  dueDate            DateTime?
  fixedAt            DateTime?
  riskScore          Float?
  businessImpact     String?
  metadata           Json?
  createdAt          DateTime                         @default(now())
  updatedAt          DateTime                         @updatedAt
  organizationId     String
  assets             AssetVulnerability[]
  comments           Comment[]
  organization       Organization                     @relation(fields: [organizationId], references: [id])
  complianceControls VulnerabilityComplianceControl[]

  @@index([cveId])
  @@index([severity])
  @@index([status])
  @@index([organizationId])
  @@index([isExploited])
  @@index([riskScore])
}

model AssetVulnerability {
  id              String        @id @default(cuid())
  assetId         String
  vulnerabilityId String
  port            Int?
  protocol        String?
  service         String?
  path            String?
  evidence        String?
  status          VulnStatus    @default(OPEN)
  firstDetected   DateTime      @default(now())
  lastSeen        DateTime      @default(now())
  asset           Asset         @relation(fields: [assetId], references: [id], onDelete: Cascade)
  vulnerability   Vulnerability @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)

  @@unique([assetId, vulnerabilityId])
  @@index([assetId])
  @@index([vulnerabilityId])
  @@index([status])
}

model ComplianceFramework {
  id             String              @id @default(cuid())
  name           String
  version        String?
  description    String?
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  organizationId String
  controls       ComplianceControl[]
  organization   Organization        @relation(fields: [organizationId], references: [id])

  @@index([name])
  @@index([organizationId])
}

model ComplianceControl {
  id                   String                           @id @default(cuid())
  controlId            String
  title                String
  description          String?
  category             String?
  objective            String?
  status               ComplianceStatus                 @default(NOT_ASSESSED)
  implementationStatus ImplementationStatus             @default(NOT_IMPLEMENTED)
  evidence             String?
  notes                String?
  lastAssessed         DateTime?
  nextAssessment       DateTime?
  createdAt            DateTime                         @default(now())
  updatedAt            DateTime                         @updatedAt
  frameworkId          String
  assets               AssetComplianceControl[]
  framework            ComplianceFramework              @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  vulnerabilities      VulnerabilityComplianceControl[]

  @@unique([frameworkId, controlId])
  @@index([frameworkId])
  @@index([status])
  @@index([controlId])
}

model AssetComplianceControl {
  id         String            @id @default(cuid())
  assetId    String
  controlId  String
  status     ComplianceStatus  @default(NOT_ASSESSED)
  evidence   String?
  assessedAt DateTime?
  asset      Asset             @relation(fields: [assetId], references: [id], onDelete: Cascade)
  control    ComplianceControl @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@unique([assetId, controlId])
  @@index([assetId])
  @@index([controlId])
}

model VulnerabilityComplianceControl {
  id              String            @id @default(cuid())
  vulnerabilityId String
  controlId       String
  impact          String?
  control         ComplianceControl @relation(fields: [controlId], references: [id], onDelete: Cascade)
  vulnerability   Vulnerability     @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)

  @@unique([vulnerabilityId, controlId])
  @@index([vulnerabilityId])
  @@index([controlId])
}

model ThreatFeed {
  id           String            @id @default(cuid())
  name         String
  source       String
  type         ThreatFeedType
  url          String?
  apiKey       String?
  isActive     Boolean           @default(true)
  lastSync     DateTime?
  syncInterval Int               @default(3600)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  indicators   ThreatIndicator[]

  @@index([name])
  @@index([isActive])
}

model ThreatIndicator {
  id          String        @id @default(cuid())
  type        IndicatorType
  value       String
  confidence  Int?
  severity    Severity?
  firstSeen   DateTime      @default(now())
  lastSeen    DateTime      @default(now())
  expiresAt   DateTime?
  source      String?
  description String?
  tags        String[]
  tacticId    String?
  techniqueId String?
  feedId      String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  feed        ThreatFeed    @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([value])
  @@index([feedId])
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  userId     String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}

model Comment {
  id              String         @id @default(cuid())
  content         String
  entityType      String
  entityId        String
  userId          String
  vulnerabilityId String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  user            User           @relation(fields: [userId], references: [id])
  vulnerability   Vulnerability? @relation(fields: [vulnerabilityId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
}

model ScannerConfig {
  id           String       @id @default(cuid())
  name         String
  type         VulnSource
  endpoint     String?
  apiKey       String?
  username     String?
  password     String?
  isActive     Boolean      @default(true)
  lastSync     DateTime?
  syncInterval Int          @default(86400)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  scanResults  ScanResult[]

  @@index([type])
  @@index([isActive])
}

model ScanResult {
  id         String        @id @default(cuid())
  scanId     String
  startTime  DateTime
  endTime    DateTime?
  status     ScanStatus    @default(RUNNING)
  totalHosts Int           @default(0)
  totalVulns Int           @default(0)
  rawData    Json?
  scannerId  String
  createdAt  DateTime      @default(now())
  scanner    ScannerConfig @relation(fields: [scannerId], references: [id])

  @@index([scanId])
  @@index([scannerId])
  @@index([status])
}

model RiskSnapshot {
  id               String   @id @default(cuid())
  date             DateTime @default(now())
  totalAssets      Int
  criticalAssets   Int
  totalVulns       Int
  criticalVulns    Int
  highVulns        Int
  mediumVulns      Int
  lowVulns         Int
  exploitedVulns   Int
  cisaKevVulns     Int
  overallRiskScore Float
  complianceScore  Float?
  metadata         Json?

  @@index([date])
}

model Setting {
  id               String       @id @default(cuid())
  organizationId   String       @unique
  timezone         String       @default("UTC")
  dateFormat       String       @default("MMM DD, YYYY")
  notifyCritical   Boolean      @default(true)
  notifyExploited  Boolean      @default(true)
  notifyCompliance Boolean      @default(true)
  notifyScan       Boolean      @default(false)
  notifyWeekly     Boolean      @default(true)
  require2FA       Boolean      @default(false)
  sessionTimeout   Int          @default(30)
  passwordPolicy   String       @default("STRONG")
  updatedAt        DateTime     @updatedAt
  organization     Organization @relation(fields: [organizationId], references: [id])
}

model Report {
  id             String       @id @default(cuid())
  name           String
  type           String
  description    String?
  format         String       @default("PDF")
  frequency      String?
  status         String       @default("PENDING")
  url            String?
  size           String?
  organizationId String
  userId         String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@index([organizationId])
  @@index([userId])
}

enum Role {
  IT_OFFICER
  PENTESTER
  ANALYST
  MAIN_OFFICER
}

enum AssetType {
  SERVER
  WORKSTATION
  NETWORK_DEVICE
  CLOUD_INSTANCE
  CONTAINER
  DATABASE
  APPLICATION
  API
  DOMAIN
  CERTIFICATE
  IOT_DEVICE
  MOBILE_DEVICE
  OTHER
}

enum Environment {
  PRODUCTION
  STAGING
  DEVELOPMENT
  TESTING
  DR
}

enum Criticality {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFORMATIONAL
}

enum AssetStatus {
  ACTIVE
  INACTIVE
  DECOMMISSIONED
  MAINTENANCE
}

enum CloudProvider {
  AWS
  AZURE
  GCP
  ORACLE
  IBM
  ALIBABA
  OTHER
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFORMATIONAL
}

enum VulnStatus {
  OPEN
  IN_PROGRESS
  MITIGATED
  FIXED
  ACCEPTED
  FALSE_POSITIVE
}

enum VulnSource {
  NESSUS
  OPENVAS
  NMAP
  TRIVY
  QUALYS
  RAPID7
  CROWDSTRIKE
  MANUAL
  API
  OTHER
}

enum ExploitMaturity {
  NOT_DEFINED
  UNPROVEN
  POC
  FUNCTIONAL
  HIGH
}

enum ComplianceStatus {
  COMPLIANT
  NON_COMPLIANT
  PARTIALLY_COMPLIANT
  NOT_ASSESSED
  NOT_APPLICABLE
}

enum ImplementationStatus {
  IMPLEMENTED
  PARTIALLY_IMPLEMENTED
  PLANNED
  NOT_IMPLEMENTED
  NOT_APPLICABLE
}

enum ThreatFeedType {
  CVE
  MALWARE
  IOC
  THREAT_ACTOR
  CAMPAIGN
}

enum IndicatorType {
  IP_ADDRESS
  DOMAIN
  URL
  FILE_HASH_MD5
  FILE_HASH_SHA1
  FILE_HASH_SHA256
  EMAIL
  CVE
  REGISTRY_KEY
  USER_AGENT
}

enum ScanStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}
